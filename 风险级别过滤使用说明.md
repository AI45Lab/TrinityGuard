# 风险级别过滤功能使用说明

## 功能概述

现在可以通过 `--risk-levels` 参数指定只测试特定级别的风险（L1、L2 或 L3），而不需要修改代码。

## 使用方法

### 只测试 L2 和 L3 风险

```bash
python tests/evoagent_bench/test_evoagent_workflows.py --risk-levels L2 L3
```

**效果**:
- 只运行 L2（6 个风险）和 L3（6 个风险）的部署前测试
- 总共测试 12 个风险，而不是 20 个
- 大幅减少测试时间

### 只测试 L2 风险

```bash
python tests/evoagent_bench/test_evoagent_workflows.py --risk-levels L2
```

**效果**:
- 只运行 L2 的 6 个风险测试
- 包括：message_tampering, malicious_propagation, misinformation_amplify, insecure_output, goal_drift, identity_spoofing

### 只测试 L3 风险

```bash
python tests/evoagent_bench/test_evoagent_workflows.py --risk-levels L3
```

**效果**:
- 只运行 L3 的 6 个风险测试
- 包括：cascading_failures, sandbox_escape, insufficient_monitoring, group_hallucination, malicious_emergence, rogue_agent

### 只测试 L1 风险（快速测试）

```bash
python tests/evoagent_bench/test_evoagent_workflows.py --risk-levels L1
```

**效果**:
- 只运行 L1 的 8 个风险测试
- 包括：jailbreak, prompt_injection, sensitive_disclosure, excessive_agency, code_execution, hallucination, memory_poisoning, tool_misuse
- **最快**：L1 测试不需要运行完整工作流

## 风险级别说明

### L1 - 单智能体风险（8 个）
- **测试速度**: 快速（每个测试用例 1-5 秒）
- **总时间**: 约 5-10 分钟
- **风险列表**:
  1. jailbreak（越狱攻击）
  2. prompt_injection（提示词注入）
  3. sensitive_disclosure（敏感信息泄露）
  4. excessive_agency（过度代理）
  5. code_execution（代码执行）
  6. hallucination（幻觉）
  7. memory_poisoning（记忆污染）
  8. tool_misuse（工具滥用）

### L2 - 智能体间通信风险（6 个）
- **测试速度**: 较慢（每个测试用例 30 秒-2 分钟）
- **总时间**: 约 20-60 分钟
- **风险列表**:
  1. message_tampering（消息篡改）
  2. malicious_propagation（恶意传播）
  3. misinformation_amplify（错误信息放大）
  4. insecure_output（不安全输出）
  5. goal_drift（目标漂移）
  6. identity_spoofing（身份欺骗）

### L3 - 系统级风险（6 个）
- **测试速度**: 最慢（每个测试用例 1-3 分钟）
- **总时间**: 约 25-70 分钟
- **风险列表**:
  1. cascading_failures（级联失败）
  2. sandbox_escape（沙箱逃逸）
  3. insufficient_monitoring（监控不足）
  4. group_hallucination（群体幻觉）
  5. malicious_emergence（恶意涌现）
  6. rogue_agent（流氓智能体）

## 组合使用

### L2 + L3 风险（推荐用于深度测试）

```bash
python tests/evoagent_bench/test_evoagent_workflows.py --risk-levels L2 L3
```

**适用场景**:
- 关注多智能体交互和系统级安全
- 跳过单智能体基础测试
- 节省约 40% 的测试时间

**时间估算**: 45-130 分钟

### 与其他参数组合

#### 1. L2+L3 + 快速模式

```bash
python tests/evoagent_bench/test_evoagent_workflows.py \
    --risk-levels L2 L3 \
    --no-llm-judge
```

**效果**: 只测试 L2 和 L3，使用启发式规则，最快的深度测试方式

#### 2. L2+L3 + 特定工作流

```bash
python tests/evoagent_bench/test_evoagent_workflows.py \
    --risk-levels L2 L3 \
    --workflows my_workflow.json
```

**效果**: 只对指定工作流测试 L2 和 L3 风险

#### 3. L1 + 快速扫描

```bash
python tests/evoagent_bench/test_evoagent_workflows.py \
    --risk-levels L1 \
    --no-llm-judge
```

**效果**: 最快的安全扫描，适合 CI/CD

## 输出示例

### 使用 --risk-levels L2 L3

```
======================================================================
  EvoAgent Workflow Security Testing
======================================================================

======================================================================
Starting tests for 1 workflow(s)
Risk levels: L2, L3
======================================================================

######################################################################
WORKFLOW 1/1 (100%): my_workflow.json
######################################################################

======================================================================
Testing workflow: my_workflow
======================================================================
Step 1: Parsing workflow...
Goal: Analyze document and generate summary

Step 2: Creating AG2MAS instance...

Step 3: Wrapping with Safety_MAS...

Step 4: Running pre-deployment tests...
  Testing risk levels: L2, L3 (12 risks)
  [1/12] (8%) Testing message_tampering...
    Test case 1/8: Starting (running workflow)...
    Test case 1/8: Completed
    ...
  [2/12] (17%) Testing malicious_propagation...
    ...
  [12/12] (100%) Testing rogue_agent...
    ...
```

## 参数参考

### --risk-levels

**语法**: `--risk-levels L1 L2 L3`

**可选值**:
- `L1` 或 `l1`: 单智能体风险
- `L2` 或 `l2`: 智能体间通信风险
- `L3` 或 `l3`: 系统级风险

**默认值**: 如果不指定，测试所有 20 个风险

**示例**:
```bash
# 只测试 L2
--risk-levels L2

# 测试 L2 和 L3
--risk-levels L2 L3

# 测试所有级别（等同于不指定参数）
--risk-levels L1 L2 L3

# 大小写不敏感
--risk-levels l2 l3
```

## 最佳实践

### 开发阶段
```bash
# 快速测试 L1（基础安全）
python tests/evoagent_bench/test_evoagent_workflows.py \
    --risk-levels L1 \
    --no-llm-judge
```

### 集成测试阶段
```bash
# 测试 L2 和 L3（多智能体交互）
python tests/evoagent_bench/test_evoagent_workflows.py \
    --risk-levels L2 L3
```

### 生产部署前
```bash
# 完整测试所有风险
python tests/evoagent_bench/test_evoagent_workflows.py
```

### CI/CD 流水线
```bash
# 分阶段测试
# Stage 1: 快速 L1 测试
python tests/evoagent_bench/test_evoagent_workflows.py \
    --risk-levels L1 \
    --no-llm-judge

# Stage 2: L2 测试（如果 Stage 1 通过）
python tests/evoagent_bench/test_evoagent_workflows.py \
    --risk-levels L2 \
    --no-llm-judge

# Stage 3: L3 测试（如果 Stage 2 通过）
python tests/evoagent_bench/test_evoagent_workflows.py \
    --risk-levels L3 \
    --no-llm-judge
```

## 时间对比

| 测试范围 | 风险数量 | 预估时间 | 适用场景 |
|---------|---------|---------|---------|
| 所有风险 | 20 | 50-140 分钟 | 生产部署前 |
| L2 + L3 | 12 | 45-130 分钟 | 深度安全测试 |
| 仅 L2 | 6 | 20-60 分钟 | 通信安全测试 |
| 仅 L3 | 6 | 25-70 分钟 | 系统级测试 |
| 仅 L1 | 8 | 5-10 分钟 | 快速基础测试 |

## 注意事项

1. **运行时监控不受影响**: `--risk-levels` 只影响部署前测试，运行时监控仍然可以通过 `--monitors` 参数单独控制

2. **组合使用**: 可以同时使用 `--risk-levels` 和 `--monitors`
   ```bash
   python tests/evoagent_bench/test_evoagent_workflows.py \
       --risk-levels L2 L3 \
       --monitors message_tampering goal_drift
   ```

3. **大小写不敏感**: `L2`、`l2`、`L2` 都可以

4. **顺序无关**: `--risk-levels L2 L3` 和 `--risk-levels L3 L2` 效果相同

## 故障排查

### 问题: 参数不生效

**检查**:
```bash
# 确保参数格式正确
python tests/evoagent_bench/test_evoagent_workflows.py --risk-levels L2 L3

# 不要使用逗号分隔
# 错误: --risk-levels L2,L3
# 正确: --risk-levels L2 L3
```

### 问题: 仍然测试了所有风险

**原因**: 可能没有正确传递参数

**解决**: 检查命令行输出，应该看到：
```
Testing risk levels: L2, L3 (12 risks)
```

而不是：
```
Testing all risk levels (20 risks)
```

## 相关文档

- **执行流程文档**: `tests/evoagent_bench/执行流程文档.md`
- **进度显示说明**: `测试用例进度显示功能说明_v2.md`
- **README**: `tests/evoagent_bench/README.md`

---

**版本**: 1.0
**日期**: 2026-02-05
**功能**: 风险级别过滤
