# 测试用例进度显示功能说明

## 功能概述

现在每个风险测试在执行时，会实时显示测试用例的进度。例如，如果一个风险有 10 个测试用例，您会看到：

```
[1/20] (5%) Testing jailbreak...
  Test case: 1/10
  Test case: 2/10
  Test case: 3/10
  ...
  Test case: 10/10
```

## 修改的文件

### 1. `src/level3_safety/risk_tests/base.py`
**修改内容**: 在 `BaseRiskTest.run()` 方法中添加了 `progress_callback` 参数

**变更**:
```python
def run(self, intermediary: MASIntermediary, use_dynamic: bool = False,
        mas_description: Optional[str] = None, task: Optional[str] = None,
        progress_callback: Optional[callable] = None) -> TestResult:
```

**功能**:
- 在执行每个测试用例前调用 `progress_callback(current, total)`
- 允许外部代码接收测试进度并显示

### 2. `src/level3_safety/safety_mas.py`
**修改内容**: 在 `Safety_MAS.run_manual_safety_tests()` 方法中添加了 `progress_callback` 参数

**变更**:
```python
def run_manual_safety_tests(self, selected_tests: List[str], task: str = None,
                            progress_callback: Optional[callable] = None) -> Dict[str, Any]:
```

**功能**:
- 接收进度回调函数并传递给风险测试
- 保持向后兼容（回调是可选的）

### 3. `tests/evoagent_bench/test_evoagent_workflows.py`
**修改内容**: 在测试脚本中添加了进度回调函数

**变更**:
```python
# 定义进度回调函数
def test_case_progress(current, total):
    # 在同一行显示测试用例进度
    print(f"\r    Test case: {current}/{total}", end='', flush=True)

# 调用测试时传入回调
result = safety_mas.run_manual_safety_tests([risk], progress_callback=test_case_progress)

# 测试完成后换行
print()
```

**功能**:
- 使用 `\r` 实现同行更新（覆盖之前的输出）
- 使用 `flush=True` 确保立即显示
- 测试完成后打印换行符，移到下一行

## 使用示例

### 基本使用

```python
from src.level3_safety.safety_mas import Safety_MAS

# 创建 Safety_MAS 实例
safety_mas = Safety_MAS(mas=your_mas_instance)

# 定义进度回调
def show_progress(current, total):
    print(f"\r  进度: {current}/{total} ({current/total*100:.0f}%)", end='', flush=True)

# 运行测试并显示进度
result = safety_mas.run_manual_safety_tests(
    ["jailbreak", "prompt_injection"],
    progress_callback=show_progress
)

# 完成后换行
print()
```

### 在测试脚本中使用

完整的测试脚本已经集成了这个功能。运行：

```bash
python tests/evoagent_bench/test_evoagent_workflows.py
```

您会看到每个风险测试的测试用例进度。

### 演示脚本

我们提供了一个演示脚本来展示这个功能：

```bash
python test_progress_demo.py
```

这个脚本会：
1. 加载一个工作流
2. 运行 3 个风险测试（演示用）
3. 显示每个测试用例的实时进度
4. 显示测试结果摘要

## 输出示例

### 之前的输出
```
Step 4: Running pre-deployment tests (20 risks)...
  [1/20] (5%) Testing jailbreak...
  [2/20] (10%) Testing prompt_injection...
  [3/20] (15%) Testing sensitive_disclosure...
```

### 现在的输出
```
Step 4: Running pre-deployment tests (20 risks)...
  [1/20] (5%) Testing jailbreak...
    Test case: 1/10
    Test case: 2/10
    Test case: 3/10
    Test case: 4/10
    Test case: 5/10
    Test case: 6/10
    Test case: 7/10
    Test case: 8/10
    Test case: 9/10
    Test case: 10/10
  [2/20] (10%) Testing prompt_injection...
    Test case: 1/8
    Test case: 2/8
    ...
```

## 技术细节

### 进度回调函数签名

```python
def progress_callback(current: int, total: int) -> None:
    """
    Args:
        current: 当前正在执行的测试用例编号（从 1 开始）
        total: 总测试用例数量
    """
    pass
```

### 同行更新技术

使用 `\r` (回车符) 实现同行更新：

```python
print(f"\r    Test case: {current}/{total}", end='', flush=True)
```

- `\r`: 将光标移回行首
- `end=''`: 不添加换行符
- `flush=True`: 立即刷新输出缓冲区

### 向后兼容性

所有修改都是向后兼容的：
- `progress_callback` 参数是可选的（默认为 `None`）
- 如果不提供回调，行为与之前完全相同
- 现有代码无需修改即可继续工作

## 自定义进度显示

您可以自定义进度显示格式：

### 百分比显示
```python
def progress_callback(current, total):
    percentage = (current / total) * 100
    print(f"\r  进度: {percentage:.1f}% ({current}/{total})", end='', flush=True)
```

### 进度条显示
```python
def progress_callback(current, total):
    bar_length = 30
    filled = int(bar_length * current / total)
    bar = '█' * filled + '░' * (bar_length - filled)
    print(f"\r  [{bar}] {current}/{total}", end='', flush=True)
```

### 详细信息显示
```python
def progress_callback(current, total):
    print(f"\r  测试用例 {current}/{total} - 剩余 {total-current} 个", end='', flush=True)
```

## 故障排查

### 问题 1: 进度不显示

**原因**: 输出被缓冲

**解决**: 确保使用 `flush=True`

```python
print(f"\r  进度: {current}/{total}", end='', flush=True)
```

### 问题 2: 进度显示混乱

**原因**: 忘记在测试完成后换行

**解决**: 在测试完成后添加 `print()`

```python
result = safety_mas.run_manual_safety_tests([risk], progress_callback=callback)
print()  # 换行
```

### 问题 3: 日志和进度混在一起

**原因**: 日志输出和进度输出冲突

**解决**:
- 使用日志级别控制日志输出
- 或者在进度回调中使用更复杂的输出控制

## 未来改进

可能的改进方向：

1. **彩色进度条**: 使用 ANSI 颜色代码
2. **时间估算**: 显示预计剩余时间
3. **速度显示**: 显示测试用例执行速度
4. **多行进度**: 同时显示多个风险的进度
5. **GUI 进度**: 集成到图形界面

## 相关文档

- **测试系统文档**: `tests/evoagent_bench/执行流程文档.md`
- **README**: `tests/evoagent_bench/README.md`
- **风险测试基类**: `src/level3_safety/risk_tests/base.py`

---

**版本**: 1.0
**日期**: 2026-02-05
**作者**: MASSafetyGuard Team
