# L2/L3 测试超时和性能优化说明

## 问题说明

### 症状
L2 测试的第一个测试用例开始运行后，一直没有停止。

### 根本原因
L2 测试在运行工作流时**之前没有设置 max_rounds 限制**，导致：
1. 工作流可能运行很多轮对话
2. 如果工作流逻辑有问题，可能陷入死循环
3. 没有超时机制，可能无限等待

## 已修复

### 修改内容

**文件**: `src/level3_safety/risk_tests/l2_base.py`

1. **添加了配置参数**（第 48-49 行）:
   ```python
   "max_rounds": 10,  # Maximum conversation rounds for workflow execution
   "workflow_timeout": 300,  # Workflow timeout in seconds (5 minutes)
   ```

2. **在 run_single_test 中使用这些参数**（第 456-469 行）:
   ```python
   # Get workflow execution parameters from config
   max_rounds = self.config.get("max_rounds", 10)
   workflow_timeout = self.config.get("workflow_timeout", 300)

   # Run workflow with interception
   workflow_result = intermediary.run_workflow(
       task=task_to_use,
       mode=RunMode.MONITORED_INTERCEPTING,
       interceptions=interceptions,
       silent=True,
       max_rounds=max_rounds,  # 限制对话轮次
       timeout=workflow_timeout  # 设置超时
   )
   ```

### 效果

现在每个 L2 测试用例：
- ✅ 最多运行 10 轮对话
- ✅ 最多运行 5 分钟（300 秒）
- ✅ 超过限制会自动停止

## 配置说明

### 默认配置

| 参数 | 默认值 | 说明 |
|------|--------|------|
| `max_rounds` | 10 | 最大对话轮次 |
| `workflow_timeout` | 300 秒 | 工作流超时时间 |

### 如何调整配置

如果您需要调整这些参数，可以在测试类中修改：

#### 方法 1: 修改 L2 基类默认值

编辑 `src/level3_safety/risk_tests/l2_base.py`:

```python
def __init__(self):
    super().__init__()
    self.config.update({
        # ... 其他配置 ...
        "max_rounds": 15,  # 增加到 15 轮
        "workflow_timeout": 600,  # 增加到 10 分钟
    })
```

#### 方法 2: 在特定测试中覆盖

编辑特定的 L2 测试文件（如 `l2_message_tampering/test.py`）:

```python
def __init__(self):
    super().__init__()
    # 覆盖基类配置
    self.config["max_rounds"] = 20
    self.config["workflow_timeout"] = 900  # 15 分钟
```

## 性能优化建议

### 1. 减少 max_rounds

如果测试用例不需要长时间对话：

```python
"max_rounds": 5,  # 减少到 5 轮
```

**适用场景**:
- 简单的消息篡改测试
- 不需要复杂推理的测试

### 2. 减少 workflow_timeout

如果工作流应该快速完成：

```python
"workflow_timeout": 120,  # 减少到 2 分钟
```

**适用场景**:
- 快速测试
- CI/CD 流水线

### 3. 使用更简单的任务

L2 测试会自动生成任务。如果生成的任务太复杂，可以指定更简单的默认任务：

```python
"default_task": "Simple test: what is 2 + 2?",
```

### 4. 禁用 LLM 修改器

如果不需要 LLM 生成攻击载荷：

```python
"use_llm_modifier": False,
```

这样会使用固定的攻击载荷，速度更快。

## 故障排查

### 问题 1: 测试用例仍然运行很长时间

**检查**:
1. 查看日志，确认 max_rounds 是否生效
2. 检查工作流本身是否有问题
3. 尝试减少 max_rounds 到 5

**临时解决**:
```bash
# 使用 Ctrl+C 中断测试
# 然后修改配置，减少 max_rounds
```

### 问题 2: 测试用例超时

**现象**: 看到超时错误

**原因**: workflow_timeout 太短

**解决**: 增加超时时间
```python
"workflow_timeout": 600,  # 增加到 10 分钟
```

### 问题 3: 测试用例提前结束

**现象**: 工作流在完成任务前就停止了

**原因**: max_rounds 太小

**解决**: 增加对话轮次
```python
"max_rounds": 20,  # 增加到 20 轮
```

## 监控和调试

### 查看实际运行轮次

在日志中查找：
```
Round 1/10 - Agent: agent1
Round 2/10 - Agent: agent2
...
```

### 查看是否超时

在日志中查找：
```
ERROR: Workflow execution timeout after 300s
```

### 查看是否达到 max_rounds

在日志中查找：
```
Workflow stopped: reached max_rounds (10)
```

## 不同风险级别的配置建议

### L1 风险（单智能体）
- **max_rounds**: 不适用（不运行完整工作流）
- **测试时间**: 1-5 秒/测试用例

### L2 风险（智能体间通信）
- **max_rounds**: 10（推荐）
- **workflow_timeout**: 300 秒（推荐）
- **测试时间**: 30 秒-2 分钟/测试用例

**快速模式**:
```python
"max_rounds": 5,
"workflow_timeout": 120,
```

**深度测试模式**:
```python
"max_rounds": 20,
"workflow_timeout": 600,
```

### L3 风险（系统级）
- **max_rounds**: 5-10（已在各测试中配置）
- **测试时间**: 1-3 分钟/测试用例

## 最佳实践

### 开发阶段
```python
# 快速测试配置
"max_rounds": 5,
"workflow_timeout": 120,
"use_llm_modifier": False,
```

### 集成测试阶段
```python
# 标准配置
"max_rounds": 10,
"workflow_timeout": 300,
"use_llm_modifier": True,
```

### 生产部署前
```python
# 深度测试配置
"max_rounds": 20,
"workflow_timeout": 600,
"use_llm_modifier": True,
```

## 时间估算（更新）

### 使用默认配置（max_rounds=10）

| 风险级别 | 测试用例数 | 单个用例时间 | 总时间 |
|---------|-----------|-------------|--------|
| L2 | 6-8 个/风险 | 30 秒-2 分钟 | 3-16 分钟/风险 |
| L3 | 4-6 个/风险 | 1-3 分钟 | 4-18 分钟/风险 |

### 使用快速配置（max_rounds=5）

| 风险级别 | 测试用例数 | 单个用例时间 | 总时间 |
|---------|-----------|-------------|--------|
| L2 | 6-8 个/风险 | 15-60 秒 | 1.5-8 分钟/风险 |
| L3 | 4-6 个/风险 | 30 秒-1.5 分钟 | 2-9 分钟/风险 |

## 相关文档

- **进度显示说明**: `测试用例进度显示功能说明_v2.md`
- **风险级别过滤**: `风险级别过滤使用说明.md`
- **执行流程文档**: `tests/evoagent_bench/执行流程文档.md`

---

**版本**: 1.0
**日期**: 2026-02-05
**修复**: 添加 max_rounds 和 timeout 限制
