# Runtime Monitor 综合指标设计

## 概述

本文档设计了三层风险监控的综合指标体系，用于前端可视化和实时监控仪表盘。每一层的指标旨在提供该层级安全状态的全面视图，支持运维人员快速识别问题和做出决策。

---

## L1 层：单智能体原子风险指标

L1 层关注单个智能体自身的安全状态，包含8种原子风险。

### 1.1 综合健康分数 (Agent Health Score)

**定义**：单个智能体的整体安全健康状况评分（0-100）

**计算公式**：
```
Agent_Health_Score = 100 - Σ(risk_weight[i] × risk_severity[i])
```

其中：
- `risk_weight[i]`：第i种风险的权重（根据危害程度预设）
- `risk_severity[i]`：第i种风险当前的严重程度（0-10）

**可视化**：
- 仪表盘圆形进度条
- 颜色编码：绿色(80-100)、黄色(60-79)、橙色(40-59)、红色(0-39)

### 1.2 风险暴露指数 (Risk Exposure Index)

**定义**：衡量智能体在当前会话中暴露于各类攻击的程度

**包含子指标**：

| 子指标 | 计算方式 | 说明 |
|--------|----------|------|
| 注入攻击暴露率 | `prompt_injection_attempts / total_inputs` | 接收到的提示词注入尝试比例 |
| 越狱尝试频率 | `jailbreak_attempts / session_duration` | 每分钟遭受越狱尝试的次数 |
| 敏感请求比例 | `sensitive_requests / total_requests` | 涉及敏感操作的请求占比 |

**可视化**：
- 堆叠柱状图，按风险类型分色
- 实时趋势折线图

### 1.3 响应安全性评分 (Response Safety Score)

**定义**：智能体输出内容的安全性评估

**计算公式**：
```
Response_Safety_Score = (safe_responses / total_responses) × 100
```

**检测维度**：
- 幻觉内容检出率
- 敏感信息泄露次数
- 超权限操作建议次数
- 恶意代码输出检出

**可视化**：
- 环形图展示安全/风险响应比例
- 时间序列图显示趋势

### 1.4 工具使用合规率 (Tool Compliance Rate)

**定义**：智能体使用外部工具时的合规程度

**计算公式**：
```
Tool_Compliance_Rate = (authorized_tool_calls / total_tool_calls) × 100
```

**监控维度**：
- 未授权工具调用次数
- 工具参数越界次数
- 资源消耗异常次数

**可视化**：
- 合规/违规工具调用饼图
- 工具使用热力图

### 1.5 记忆完整性指标 (Memory Integrity Index)

**定义**：智能体长期记忆的可信度评估

**监控维度**：
- 可疑记忆注入检测数
- 记忆内容一致性评分
- 记忆来源可追溯性

**可视化**：
- 记忆条目健康状态表格
- 完整性随时间变化图

---

## L2 层：智能体间通信风险指标

L2 层关注多智能体交互和通信过程中的安全风险，包含6种通信风险。

### 2.1 通信信任度 (Communication Trust Score)

**定义**：智能体间通信的整体可信度评分（0-100）

**计算公式**：
```
Communication_Trust = 100 - (tampered_messages + spoofed_messages) / total_messages × 100
```

**可视化**：
- 信任度仪表盘
- 智能体间通信信任矩阵热力图

### 2.2 信息传播风险指数 (Information Propagation Risk)

**定义**：衡量恶意或错误信息在智能体网络中传播的风险

**包含子指标**：

| 子指标 | 定义 | 告警阈值 |
|--------|------|----------|
| 恶意指令传播深度 | 恶意指令经过的智能体数量 | > 2 |
| 错误信息放大系数 | 错误信息被引用/转发的次数 | > 3 |
| 传播速度 | 信息传播至n个智能体的时间 | < 1秒/节点 |

**可视化**：
- 网络拓扑图，节点颜色表示感染状态
- 传播路径追踪图

### 2.3 消息完整性率 (Message Integrity Rate)

**定义**：消息在传输过程中保持完整性的比例

**计算公式**：
```
Message_Integrity_Rate = (verified_messages / total_messages) × 100
```

**检测方式**：
- 消息哈希校验
- 签名验证
- 内容一致性检查

**可视化**：
- 完整性状态实时监控
- 异常消息告警列表

### 2.4 身份验证成功率 (Identity Verification Rate)

**定义**：智能体间通信中身份验证的成功率

**计算公式**：
```
ID_Verification_Rate = (verified_identities / total_communications) × 100
```

**监控维度**：
- 身份伪造尝试次数
- 验证失败原因分类
- 未验证通信占比

**可视化**：
- 认证成功/失败堆叠图
- 伪造尝试来源分析

### 2.5 目标一致性指数 (Goal Alignment Index)

**定义**：衡量智能体在协作过程中保持目标一致性的程度

**计算公式**：
```
Goal_Alignment = 1 - |current_goal_vector - original_goal_vector| / max_drift
```

**检测维度**：
- 目标偏移量
- 偏移速度
- 偏移方向

**可视化**：
- 目标向量雷达图
- 目标漂移趋势图

### 2.6 输出处理安全评分 (Output Handling Score)

**定义**：智能体对接收到的输出进行安全处理的评分

**监控维度**：
- 未经验证直接使用的输出数
- 输入净化执行率
- 危险输出拦截率

**可视化**：
- 输出处理流程监控图
- 安全处理覆盖率

---

## L3 层：系统级涌现风险指标

L3 层关注整个多智能体系统的涌现性风险，包含6种系统级风险。

### 3.1 系统稳定性指数 (System Stability Index)

**定义**：整个MAS系统的稳定运行状况评分（0-100）

**计算公式**：
```
System_Stability = 100 × (1 - cascade_risk) × (1 - rogue_risk) × monitoring_coverage
```

其中：
- `cascade_risk`：级联失败风险系数
- `rogue_risk`：叛逆智能体风险系数
- `monitoring_coverage`：监控覆盖率

**可视化**：
- 系统稳定性仪表盘
- 稳定性历史趋势图

### 3.2 级联失败风险系数 (Cascade Failure Risk)

**定义**：衡量单点故障引发系统级崩溃的风险

**计算公式**：
```
Cascade_Risk = Σ(node_criticality[i] × failure_probability[i] × propagation_factor[i])
```

**监控维度**：
- 关键节点依赖度
- 故障传播路径数
- 恢复时间估算

**可视化**：
- 系统依赖关系图
- 关键路径高亮
- 故障模拟热力图

### 3.3 沙箱逃逸检测指标 (Sandbox Breach Indicators)

**定义**：检测智能体尝试突破沙箱隔离的指标

**监控维度**：

| 指标 | 说明 | 严重级别 |
|------|------|----------|
| 越界访问尝试数 | 尝试访问未授权资源 | Critical |
| 权限提升请求数 | 请求更高权限的次数 | Warning |
| 系统调用异常率 | 异常系统调用占比 | Warning |
| 网络边界探测数 | 探测网络边界的尝试 | Critical |

**可视化**：
- 沙箱边界可视化图
- 越界尝试实时告警
- 访问模式异常检测图

### 3.4 监控覆盖率 (Monitoring Coverage)

**定义**：系统中被有效监控的组件比例

**计算公式**：
```
Monitoring_Coverage = (monitored_components / total_components) × 100
```

**监控维度**：
- 智能体监控覆盖率
- 通信链路监控率
- 关键事件捕获率
- 日志完整性

**可视化**：
- 监控覆盖地图
- 盲区告警
- 日志健康状态

### 3.5 群体行为异常指数 (Collective Anomaly Index)

**定义**：检测智能体群体出现异常协同行为的指标

**计算公式**：
```
Collective_Anomaly = deviation_from_baseline(group_behavior_vector)
```

**检测维度**：
- 群体幻觉检测（多个智能体产生一致但错误的输出）
- 恶意涌现检测（未预期的有害协同行为）
- 共识偏差检测（群体决策偏离预期）

**可视化**：
- 群体行为模式图
- 异常聚类检测图
- 共识偏差雷达图

### 3.6 叛逆智能体检测指标 (Rogue Agent Detection)

**定义**：识别脱离系统目标、追求自身目标的智能体

**检测维度**：

| 指标 | 计算方式 | 阈值 |
|------|----------|------|
| 目标偏离度 | `|agent_goal - system_goal|` | > 0.5 |
| 独立行动率 | 未经协调的独立操作占比 | > 30% |
| 资源垄断倾向 | 单一智能体资源占用比 | > 50% |
| 通信隔离度 | 与其他智能体通信的减少程度 | > 70%减少 |

**可视化**：
- 智能体行为异常评分卡
- 叛逆风险排行榜
- 行为轨迹对比图

---

## 跨层综合指标

### 全局安全态势评分 (Overall Security Posture)

**定义**：整合三层风险的系统整体安全评分

**计算公式**：
```
Security_Posture = w1 × L1_Score + w2 × L2_Score + w3 × L3_Score
```

其中：
- `w1 = 0.3`（单智能体层权重）
- `w2 = 0.3`（通信层权重）
- `w3 = 0.4`（系统层权重）

**可视化**：
- 三层雷达图
- 综合仪表盘
- 趋势对比图

### 告警统计面板 (Alert Statistics Panel)

**包含指标**：

| 指标 | 说明 |
|------|------|
| 总告警数 | 当前会话/时段的告警总数 |
| 按层级分布 | L1/L2/L3 告警数量分布 |
| 按严重度分布 | Critical/Warning/Info 分布 |
| 告警趋势 | 告警数量随时间变化 |
| 平均响应时间 | 从检测到处理的平均时间 |
| 解决率 | 已处理告警占比 |

**可视化**：
- 告警数量趋势图
- 严重度分布饼图
- 风险类型热力图

---

## 指标采集与更新策略

### 实时指标（更新频率 < 1秒）

- Agent Health Score（按消息更新）
- Message Integrity Rate
- 告警计数器

### 准实时指标（更新频率 1-5秒）

- Communication Trust Score
- Risk Exposure Index
- Sandbox Breach Indicators

### 聚合指标（更新频率 5-30秒）

- System Stability Index
- Collective Anomaly Index
- Goal Alignment Index

### 统计指标（更新频率 > 30秒）

- Monitoring Coverage
- Security Posture
- 趋势分析指标

---

## 前端可视化建议

### Dashboard 布局

```
┌─────────────────────────────────────────────────────────────────┐
│                    Overall Security Posture                     │
│                    [综合安全态势仪表盘]                          │
├──────────────────┬──────────────────┬──────────────────────────┤
│   L1 面板        │   L2 面板        │   L3 面板               │
│ ┌──────────────┐ │ ┌──────────────┐ │ ┌──────────────────────┐ │
│ │Health Score  │ │ │Trust Score   │ │ │Stability Index       │ │
│ │    [85]      │ │ │    [92]      │ │ │       [78]           │ │
│ └──────────────┘ │ └──────────────┘ │ └──────────────────────┘ │
│ • Risk Exposure  │ • Propagation    │ • Cascade Risk          │
│ • Response Safety│ • Msg Integrity  │ • Sandbox Status        │
│ • Tool Compliance│ • ID Verify      │ • Coverage              │
│ • Memory Status  │ • Goal Drift     │ • Anomaly Index         │
├──────────────────┴──────────────────┴──────────────────────────┤
│                      实时告警流                                  │
│ [CRITICAL] L1-Jailbreak | Agent_A | 2024-01-15 14:32:01       │
│ [WARNING]  L2-Tampering | Comm_B  | 2024-01-15 14:31:58       │
├────────────────────────────────────────────────────────────────┤
│                      趋势图表区域                                │
│ [告警趋势] [风险分布] [智能体健康状态] [系统稳定性]            │
└────────────────────────────────────────────────────────────────┘
```

### 交互功能

1. **下钻查看**：点击任意指标可查看详细数据和历史趋势
2. **时间范围选择**：支持实时/1小时/24小时/7天等时间范围切换
3. **告警过滤**：按层级、严重度、风险类型筛选告警
4. **智能体选择**：聚焦查看特定智能体的详细指标
5. **导出报告**：生成安全评估报告（PDF/JSON）

---

## 后续实现建议

1. **数据采集层**：扩展现有 `AgentStepLog` 结构，增加指标计算所需字段
2. **指标计算层**：实现 `MetricsCalculator` 类，封装各指标计算逻辑
3. **存储层**：使用时序数据库（如 InfluxDB）存储指标历史数据
4. **API 层**：提供 RESTful API 或 WebSocket 接口供前端消费
5. **前端层**：使用 React + ECharts/D3.js 实现可视化仪表盘

---

## 版本历史

| 版本 | 日期 | 说明 |
|------|------|------|
| v0.1 | 2025-01-26 | 初始设计文档 |
