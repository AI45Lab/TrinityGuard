# æµ‹è¯•æ—¥å¿—ä¿å­˜åŠŸèƒ½è¯´æ˜

## åŠŸèƒ½æ¦‚è¿°

ä¸º `test_all_l1_risks.py` å’Œ `test_all_l2_risks.py` æ·»åŠ äº†è‡ªåŠ¨ä¿å­˜æµ‹è¯•ç»“æœåˆ° JSON æ–‡ä»¶çš„åŠŸèƒ½ã€‚

## ä¿®æ”¹çš„æ–‡ä»¶

### 1. `tests/level3_safety/test_all_l1_risks.py`

**æ–°å¢åŠŸèƒ½**:
- æ·»åŠ  `save_test_results()` å‡½æ•°
- æ·»åŠ  `--output-dir` å‘½ä»¤è¡Œå‚æ•°
- æµ‹è¯•è¿è¡Œå®Œæˆåè‡ªåŠ¨ä¿å­˜ç»“æœåˆ° JSON æ–‡ä»¶

**æ–°å¢å¯¼å…¥**:
```python
import json
import time
from datetime import datetime
```

**æ–°å¢å‡½æ•°**:
```python
def save_test_results(results: dict, output_dir: Path, use_llm_judge: bool):
    """ä¿å­˜æµ‹è¯•ç»“æœåˆ° JSON æ–‡ä»¶"""
    # åˆ›å»ºè¾“å‡ºç›®å½•
    # ç”Ÿæˆæ—¶é—´æˆ³
    # å‡†å¤‡æŠ¥å‘Šæ•°æ®
    # ä¿å­˜åˆ° JSON æ–‡ä»¶
```

**æ–°å¢å‚æ•°**:
```bash
--output-dir    æ—¥å¿—è¾“å‡ºç›®å½•ï¼ˆé»˜è®¤: ./logs/l1_testsï¼‰
```

### 2. `tests/level3_safety/test_all_l2_risks.py`

**æ–°å¢åŠŸèƒ½**:
- æ·»åŠ  `save_test_results()` å‡½æ•°
- æ·»åŠ  `--output-dir` å‘½ä»¤è¡Œå‚æ•°
- ä¿®æ”¹ `run_actual_tests()` å‡½æ•°ï¼Œæ·»åŠ  `output_dir` å‚æ•°
- æµ‹è¯•è¿è¡Œå®Œæˆåè‡ªåŠ¨ä¿å­˜ç»“æœåˆ° JSON æ–‡ä»¶

**æ–°å¢å¯¼å…¥**:
```python
import json
import time
from datetime import datetime
```

**æ–°å¢å‡½æ•°**:
```python
def save_test_results(results: dict, output_dir: Path, use_llm_judge: bool):
    """ä¿å­˜æµ‹è¯•ç»“æœåˆ° JSON æ–‡ä»¶"""
    # åˆ›å»ºè¾“å‡ºç›®å½•
    # ç”Ÿæˆæ—¶é—´æˆ³
    # å‡†å¤‡æŠ¥å‘Šæ•°æ®ï¼ˆåŒ…å«æ›´è¯¦ç»†çš„ç»Ÿè®¡ä¿¡æ¯ï¼‰
    # ä¿å­˜åˆ° JSON æ–‡ä»¶
```

**æ–°å¢å‚æ•°**:
```bash
--output-dir    æ—¥å¿—è¾“å‡ºç›®å½•ï¼ˆé»˜è®¤: ./logs/l2_testsï¼‰
```

## ä½¿ç”¨æ–¹å¼

### L1 æµ‹è¯•

```bash
# è¿è¡Œæµ‹è¯•å¹¶ä¿å­˜åˆ°é»˜è®¤ç›®å½• (./logs/l1_tests)
python tests/level3_safety/test_all_l1_risks.py --run

# è¿è¡Œæµ‹è¯•å¹¶ä¿å­˜åˆ°æŒ‡å®šç›®å½•
python tests/level3_safety/test_all_l1_risks.py --run --output-dir ./my_logs

# è¿è¡ŒæŒ‡å®šæµ‹è¯•å¹¶ä¿å­˜ç»“æœ
python tests/level3_safety/test_all_l1_risks.py --run --tests jailbreak prompt_injection --output-dir ./logs/l1_tests
```

### L2 æµ‹è¯•

```bash
# è¿è¡Œæµ‹è¯•å¹¶ä¿å­˜åˆ°é»˜è®¤ç›®å½• (./logs/l2_tests)
python tests/level3_safety/test_all_l2_risks.py --run

# è¿è¡Œæµ‹è¯•å¹¶ä¿å­˜åˆ°æŒ‡å®šç›®å½•
python tests/level3_safety/test_all_l2_risks.py --run --output-dir ./my_logs

# è¿è¡ŒæŒ‡å®šæµ‹è¯•å¹¶ä¿å­˜ç»“æœ
python tests/level3_safety/test_all_l2_risks.py --run --tests malicious_propagation goal_drift --output-dir ./logs/l2_tests
```

## æ—¥å¿—æ–‡ä»¶æ ¼å¼

### L1 æµ‹è¯•æ—¥å¿—æ ¼å¼

æ–‡ä»¶å: `l1_test_results_<æ—¶é—´æˆ³>.json`

```json
{
  "test_type": "L1_risks",
  "timestamp": "20260204_153045",
  "datetime": "2026-02-04T15:30:45.123456",
  "configuration": {
    "use_llm_judge": true,
    "tests_run": ["jailbreak", "prompt_injection"]
  },
  "summary": {
    "total_tests": 2,
    "passed_tests": 2,
    "failed_tests": 0
  },
  "results": {
    "jailbreak": true,
    "prompt_injection": true
  }
}
```

### L2 æµ‹è¯•æ—¥å¿—æ ¼å¼

æ–‡ä»¶å: `l2_test_results_<æ—¶é—´æˆ³>.json`

```json
{
  "test_type": "L2_risks",
  "timestamp": "20260204_153045",
  "datetime": "2026-02-04T15:30:45.123456",
  "configuration": {
    "use_llm_judge": true,
    "tests_run": ["malicious_propagation", "goal_drift"]
  },
  "summary": {
    "total_tests": 2,
    "passed_tests": 2,
    "failed_tests": 0,
    "total_cases": 12,
    "failed_cases": 0
  },
  "results": {
    "malicious_propagation": {
      "passed": true,
      "total_cases": 6,
      "failed_cases": 0,
      "case_results": { ... }
    },
    "goal_drift": {
      "passed": true,
      "total_cases": 6,
      "failed_cases": 0,
      "case_results": { ... }
    }
  }
}
```

## æ—¥å¿—ä¿å­˜ä½ç½®

### é»˜è®¤ä½ç½®

- **L1 æµ‹è¯•**: `./logs/l1_tests/l1_test_results_<æ—¶é—´æˆ³>.json`
- **L2 æµ‹è¯•**: `./logs/l2_tests/l2_test_results_<æ—¶é—´æˆ³>.json`

### è‡ªå®šä¹‰ä½ç½®

ä½¿ç”¨ `--output-dir` å‚æ•°æŒ‡å®šï¼š

```bash
# L1 æµ‹è¯•ä¿å­˜åˆ°è‡ªå®šä¹‰ç›®å½•
python tests/level3_safety/test_all_l1_risks.py --run --output-dir /path/to/logs

# L2 æµ‹è¯•ä¿å­˜åˆ°è‡ªå®šä¹‰ç›®å½•
python tests/level3_safety/test_all_l2_risks.py --run --output-dir /path/to/logs
```

## è¾“å‡ºç¤ºä¾‹

### è¿è¡Œ L1 æµ‹è¯•

```bash
$ python tests/level3_safety/test_all_l1_risks.py --run --tests jailbreak

======================================================================
  è¿è¡Œ L1 é£é™©æµ‹è¯•
  å…± 1 ä¸ªæµ‹è¯•
======================================================================

æ­¥éª¤ 1: åˆ›å»ºæµ‹è¯•ç”¨ MAS...
  âœ“ MAS åˆ›å»ºæˆåŠŸï¼ŒåŒ…å« 3 ä¸ªæ™ºèƒ½ä½“

æ­¥éª¤ 2: åˆ›å»º Safety_MAS åŒ…è£…å™¨...
  âœ“ Safety_MAS åˆ›å»ºæˆåŠŸ
    å¯ç”¨é£é™©æµ‹è¯•: 14
    å¯ç”¨ç›‘æ§å™¨: 14

æ­¥éª¤ 3: è¿è¡Œæµ‹è¯•...
  ä½¿ç”¨ LLM Judge: True

======================================================================
  è¿è¡Œæµ‹è¯•: jailbreak
  å®é™…æ‰§è¡Œæµ‹è¯•
======================================================================
âœ“ ä½¿ç”¨ LLM Judge è¿›è¡Œè¯„ä¼°

æµ‹è¯•ç”¨ä¾‹æ•°: 4
--------------------------------------------------

ğŸ”„ æ­£åœ¨è¿è¡Œæµ‹è¯•...

âœ“ æµ‹è¯•é€šè¿‡: 4/4 ä¸ªç”¨ä¾‹æˆåŠŸ

======================================================================
  æµ‹è¯•æ€»ç»“
======================================================================
âœ“ é€šè¿‡: 1/1

======================================================================
  ä¿å­˜æµ‹è¯•ç»“æœ
======================================================================
âœ“ æµ‹è¯•ç»“æœå·²ä¿å­˜åˆ°: logs/l1_tests/l1_test_results_20260204_153045.json
  è¾“å‡ºç›®å½•: /path/to/TrinityGuard/logs/l1_tests
```

### è¿è¡Œ L2 æµ‹è¯•

```bash
$ python tests/level3_safety/test_all_l2_risks.py --run --tests malicious_propagation

======================================================================
  Tiar 2 å±‚ï¼šå¤šæ™ºèƒ½ä½“äº¤äº’é£é™©æµ‹è¯• - å®é™…è¿è¡Œæ¨¡å¼
======================================================================

æ­¥éª¤ 1: åˆ›å»ºæµ‹è¯•ç”¨ MAS...
  OK MAS åˆ›å»ºæˆåŠŸï¼ŒåŒ…å« 3 ä¸ªæ™ºèƒ½ä½“

æ­¥éª¤ 2: åˆ›å»º Safety_MAS åŒ…è£…å™¨...
  OK Safety_MAS åˆ›å»ºæˆåŠŸ
    å¯ç”¨é£é™©æµ‹è¯•: 14
    å¯ç”¨ç›‘æ§å™¨: 14

æ­¥éª¤ 3: é…ç½®æµ‹è¯•...
  é€‰ä¸­çš„æµ‹è¯•: ['malicious_propagation']
  ä½¿ç”¨ LLM Judge: True

æ­¥éª¤ 4: è¿è¡Œæµ‹è¯•...
----------------------------------------------------------------------

[1/1] è¿è¡Œ L2.1 æ¶æ„ä¼ æ’­ (malicious_propagation)...
  é£é™©çº§åˆ«: L2
  æµ‹è¯•ç”¨ä¾‹æ•°: 6
  æµ‹è¯•ç±»åˆ«: Agent Wrapper
  OK æµ‹è¯•é€šè¿‡ (6/6 ç”¨ä¾‹)

======================================================================
  æµ‹è¯•ç»“æœæ±‡æ€»
======================================================================
  OK L2.1 æ¶æ„ä¼ æ’­: é€šè¿‡

----------------------------------------------------------------------
  æ€»è®¡: 1/1 æµ‹è¯•é€šè¿‡
  ç”¨ä¾‹: 6/6 é€šè¿‡
----------------------------------------------------------------------

======================================================================
  ä¿å­˜æµ‹è¯•ç»“æœ
======================================================================
  OK æµ‹è¯•ç»“æœå·²ä¿å­˜åˆ°: logs/l2_tests/l2_test_results_20260204_153045.json
  è¾“å‡ºç›®å½•: /path/to/TrinityGuard/logs/l2_tests
```

## æ—¥å¿—æ–‡ä»¶å†…å®¹è¯´æ˜

### é€šç”¨å­—æ®µ

| å­—æ®µ | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| `test_type` | æµ‹è¯•ç±»å‹ | "L1_risks" æˆ– "L2_risks" |
| `timestamp` | æ—¶é—´æˆ³ï¼ˆæ–‡ä»¶åæ ¼å¼ï¼‰ | "20260204_153045" |
| `datetime` | ISO æ ¼å¼æ—¥æœŸæ—¶é—´ | "2026-02-04T15:30:45.123456" |
| `configuration` | æµ‹è¯•é…ç½® | åŒ…å« use_llm_judge å’Œ tests_run |
| `summary` | æµ‹è¯•æ€»ç»“ | åŒ…å«ç»Ÿè®¡ä¿¡æ¯ |
| `results` | è¯¦ç»†ç»“æœ | æ¯ä¸ªæµ‹è¯•çš„ç»“æœ |

### L1 ç‰¹æœ‰å­—æ®µ

- `results`: ç®€å•çš„å¸ƒå°”å€¼å­—å…¸ï¼Œè¡¨ç¤ºæ¯ä¸ªæµ‹è¯•æ˜¯å¦é€šè¿‡

### L2 ç‰¹æœ‰å­—æ®µ

- `summary.total_cases`: æ€»æµ‹è¯•ç”¨ä¾‹æ•°
- `summary.failed_cases`: å¤±è´¥çš„æµ‹è¯•ç”¨ä¾‹æ•°
- `results.<test_name>`: åŒ…å«è¯¦ç»†çš„æµ‹è¯•ç»“æœå¯¹è±¡

## é”™è¯¯å¤„ç†

å¦‚æœä¿å­˜æ—¥å¿—å¤±è´¥ï¼Œä¼šæ˜¾ç¤ºé”™è¯¯ä¿¡æ¯ä½†ä¸ä¼šä¸­æ–­ç¨‹åºï¼š

```
======================================================================
  ä¿å­˜æµ‹è¯•ç»“æœ
======================================================================
âœ— ä¿å­˜æµ‹è¯•ç»“æœå¤±è´¥: [Errno 13] Permission denied: 'logs/l1_tests'
Traceback (most recent call last):
  ...
```

## ä¸å…¶ä»–æ—¥å¿—ç³»ç»Ÿçš„å…³ç³»

### step4_level3_safety.py

- ä½¿ç”¨ `log_session_manager` åˆ›å»ºä¼šè¯æ–‡ä»¶å¤¹
- ä¿å­˜ä½ç½®: `examples/full_demo/logs/log/<æ—¶é—´æˆ³>/`
- åŒ…å«æ›´å¤šä¿¡æ¯ï¼šä¼šè¯æ—¥å¿—ã€ç»¼åˆæŠ¥å‘Šã€ç”Ÿæˆçš„æ–‡ä»¶ç­‰

### test_all_l1_risks.py å’Œ test_all_l2_risks.py

- ç®€å•çš„ JSON æ–‡ä»¶ä¿å­˜
- ä¿å­˜ä½ç½®: `./logs/l1_tests/` æˆ– `./logs/l2_tests/`
- åªåŒ…å«æµ‹è¯•ç»“æœ

## ä¼˜åŠ¿

1. **ç®€å•**: ä¸ä¾èµ–å¤æ‚çš„ä¼šè¯ç®¡ç†ç³»ç»Ÿ
2. **ç‹¬ç«‹**: æ¯æ¬¡è¿è¡Œç”Ÿæˆç‹¬ç«‹çš„ JSON æ–‡ä»¶
3. **å¯è¿½æº¯**: æ—¶é—´æˆ³æ–‡ä»¶åä¾¿äºè¿½è¸ªå†å²æµ‹è¯•
4. **å¯é…ç½®**: å¯ä»¥è‡ªå®šä¹‰è¾“å‡ºç›®å½•
5. **æ ‡å‡†æ ¼å¼**: JSON æ ¼å¼ä¾¿äºè§£æå’Œåˆ†æ

## åç»­æ”¹è¿›å»ºè®®

1. **æ·»åŠ æ›´å¤šå…ƒæ•°æ®**: å¦‚è¿è¡Œç¯å¢ƒã€Python ç‰ˆæœ¬ã€ä¾èµ–ç‰ˆæœ¬ç­‰
2. **æ”¯æŒå¤šç§æ ¼å¼**: é™¤äº† JSONï¼Œè¿˜å¯ä»¥æ”¯æŒ CSVã€HTML æŠ¥å‘Šç­‰
3. **æµ‹è¯•å†å²å¯¹æ¯”**: æ¯”è¾ƒä¸åŒæ—¶é—´çš„æµ‹è¯•ç»“æœ
4. **è‡ªåŠ¨æ¸…ç†**: è‡ªåŠ¨åˆ é™¤è¿‡æœŸçš„æ—¥å¿—æ–‡ä»¶
5. **é›†æˆåˆ° CI/CD**: åœ¨æŒç»­é›†æˆä¸­è‡ªåŠ¨è¿è¡Œå¹¶ä¿å­˜ç»“æœ

## æ€»ç»“

é€šè¿‡æ·»åŠ æ—¥å¿—ä¿å­˜åŠŸèƒ½ï¼Œç°åœ¨å¯ä»¥ï¼š

- âœ“ è‡ªåŠ¨ä¿å­˜æµ‹è¯•ç»“æœåˆ° JSON æ–‡ä»¶
- âœ“ è‡ªå®šä¹‰æ—¥å¿—è¾“å‡ºç›®å½•
- âœ“ è¿½è¸ªå†å²æµ‹è¯•ç»“æœ
- âœ“ ä¾¿äºåˆ†æå’ŒæŠ¥å‘Šç”Ÿæˆ
- âœ“ ä¸ç°æœ‰æµ‹è¯•æµç¨‹æ— ç¼é›†æˆ

è¿™ä½¿å¾—æµ‹è¯•ç»“æœæ›´å®¹æ˜“è¿½è¸ªå’Œåˆ†æï¼Œç‰¹åˆ«æ˜¯åœ¨éœ€è¦å¯¹æ¯”ä¸åŒæ—¶é—´ç‚¹çš„æµ‹è¯•ç»“æœæ—¶ã€‚
