# EvoAgent Workflow å®‰å…¨æµ‹è¯•ç³»ç»Ÿ - è¯¦ç»†æ‰§è¡Œæµç¨‹æ–‡æ¡£

## ç›®å½•
1. [ç³»ç»Ÿæ¦‚è¿°](#ç³»ç»Ÿæ¦‚è¿°)
2. [æ ¸å¿ƒæ¶æ„](#æ ¸å¿ƒæ¶æ„)
3. [è¯¦ç»†æ‰§è¡Œæµç¨‹](#è¯¦ç»†æ‰§è¡Œæµç¨‹)
4. [å…³é”®ç»„ä»¶è¯´æ˜](#å…³é”®ç»„ä»¶è¯´æ˜)
5. [è¾“å‡ºç»“æ„](#è¾“å‡ºç»“æ„)
6. [é…ç½®é€‰é¡¹](#é…ç½®é€‰é¡¹)
7. [ä½¿ç”¨ç¤ºä¾‹](#ä½¿ç”¨ç¤ºä¾‹)

---

## ç³»ç»Ÿæ¦‚è¿°

### åŠŸèƒ½å®šä½
EvoAgent Workflow å®‰å…¨æµ‹è¯•ç³»ç»Ÿæ˜¯ MASSafetyGuard æ¡†æ¶çš„é›†æˆæµ‹è¯•å·¥å…·ï¼Œç”¨äºå¯¹ EvoAgentX å·¥ä½œæµè¿›è¡Œå…¨é¢çš„å®‰å…¨æ€§æµ‹è¯•å’Œç›‘æ§ã€‚

### æ ¸å¿ƒèƒ½åŠ›
- **éƒ¨ç½²å‰æµ‹è¯•ï¼ˆPre-deployment Testingï¼‰**: åœ¨å·¥ä½œæµæ‰§è¡Œå‰è¿è¡Œ 20 ç§é£é™©æµ‹è¯•
- **è¿è¡Œæ—¶ç›‘æ§ï¼ˆRuntime Monitoringï¼‰**: åœ¨å·¥ä½œæµæ‰§è¡ŒæœŸé—´å®æ—¶ç›‘æ§ 20 ç§å®‰å…¨é£é™©
- **è¯¦ç»†æ—¥å¿—è®°å½•**: ç”ŸæˆåŒ…å«å®Œæ•´æ‰§è¡Œä¸Šä¸‹æ–‡çš„ JSON æ—¥å¿—
- **æ±‡æ€»æŠ¥å‘Š**: ç”Ÿæˆè·¨æ‰€æœ‰å·¥ä½œæµçš„ Markdown æ±‡æ€»æŠ¥å‘Š

### æµ‹è¯•è¦†ç›–èŒƒå›´
ç³»ç»Ÿæµ‹è¯• MASSafetyGuard å®šä¹‰çš„å…¨éƒ¨ 20 ç§å®‰å…¨é£é™©ï¼š

**L1 é£é™©ï¼ˆå•æ™ºèƒ½ä½“å±‚é¢ - 8 ç§ï¼‰**:
- jailbreakï¼ˆè¶Šç‹±æ”»å‡»ï¼‰
- prompt_injectionï¼ˆæç¤ºè¯æ³¨å…¥ï¼‰
- sensitive_disclosureï¼ˆæ•æ„Ÿä¿¡æ¯æ³„éœ²ï¼‰
- excessive_agencyï¼ˆè¿‡åº¦ä»£ç†ï¼‰
- code_executionï¼ˆä»£ç æ‰§è¡Œï¼‰
- hallucinationï¼ˆå¹»è§‰ï¼‰
- memory_poisoningï¼ˆè®°å¿†æ±¡æŸ“ï¼‰
- tool_misuseï¼ˆå·¥å…·æ»¥ç”¨ï¼‰

**L2 é£é™©ï¼ˆæ™ºèƒ½ä½“é—´é€šä¿¡å±‚é¢ - 6 ç§ï¼‰**:
- message_tamperingï¼ˆæ¶ˆæ¯ç¯¡æ”¹ï¼‰
- malicious_propagationï¼ˆæ¶æ„ä¼ æ’­ï¼‰
- misinformation_amplifyï¼ˆé”™è¯¯ä¿¡æ¯æ”¾å¤§ï¼‰
- insecure_outputï¼ˆä¸å®‰å…¨è¾“å‡ºï¼‰
- goal_driftï¼ˆç›®æ ‡æ¼‚ç§»ï¼‰
- identity_spoofingï¼ˆèº«ä»½æ¬ºéª—ï¼‰

**L3 é£é™©ï¼ˆç³»ç»Ÿå±‚é¢ - 6 ç§ï¼‰**:
- cascading_failuresï¼ˆçº§è”å¤±è´¥ï¼‰
- sandbox_escapeï¼ˆæ²™ç®±é€ƒé€¸ï¼‰
- insufficient_monitoringï¼ˆç›‘æ§ä¸è¶³ï¼‰
- group_hallucinationï¼ˆç¾¤ä½“å¹»è§‰ï¼‰
- malicious_emergenceï¼ˆæ¶æ„æ¶Œç°ï¼‰
- rogue_agentï¼ˆæµæ°“æ™ºèƒ½ä½“ï¼‰

---

## æ ¸å¿ƒæ¶æ„

### æ–‡ä»¶ç»“æ„
```
tests/evoagent_bench/
â”œâ”€â”€ test_evoagent_workflows.py    # ä¸»æµ‹è¯•è„šæœ¬ï¼ˆ954è¡Œï¼‰
â”œâ”€â”€ README.md                      # ä½¿ç”¨æ–‡æ¡£ï¼ˆ283è¡Œï¼‰
â””â”€â”€ logs/                          # è¾“å‡ºç›®å½•
    â”œâ”€â”€ workflow_name_timestamp.json    # å•ä¸ªå·¥ä½œæµè¯¦ç»†æ—¥å¿—
    â””â”€â”€ summary_report_timestamp.md     # æ±‡æ€»æŠ¥å‘Š
```

### æ¶æ„å±‚æ¬¡
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           WorkflowTestRunnerï¼ˆæµ‹è¯•ç¼–æ’å™¨ï¼‰                â”‚
â”‚  - ç®¡ç†æ•´ä¸ªæµ‹è¯•æµç¨‹                                       â”‚
â”‚  - å¤„ç†é…ç½®å’Œè¾“å‡º                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â”œâ”€â”€> WorkflowParser (evoagentx_adapter)
             â”‚    - è§£æ EvoAgentX JSON å·¥ä½œæµ
             â”‚    - è½¬æ¢ä¸º AG2MAS å®ä¾‹
             â”‚
             â”œâ”€â”€> AG2MAS (Level 1)
             â”‚    - AG2/AutoGen æ¡†æ¶å°è£…
             â”‚    - æä¾›ç»Ÿä¸€çš„ MAS æ¥å£
             â”‚
             â”œâ”€â”€> AG2Intermediary (Level 2)
             â”‚    - æµ‹è¯•è„šæ‰‹æ¶
             â”‚    - æ¶ˆæ¯æ‹¦æˆªå’Œç»“æ„åŒ–æ—¥å¿—
             â”‚
             â””â”€â”€> Safety_MAS (Level 3)
                  - å®‰å…¨æµ‹è¯•å’Œç›‘æ§ç¼–æ’
                  - 20 ä¸ªé£é™©æµ‹è¯•æ¨¡å—
                  - 20 ä¸ªè¿è¡Œæ—¶ç›‘æ§å™¨
                  - ç»Ÿä¸€çš„ Judge ç³»ç»Ÿ

```

### å…³é”®ç±»å’Œæ•°æ®ç»“æ„

**WorkflowTestResult** (ç¬¬ 52-76 è¡Œ):
```python
@dataclass
class WorkflowTestResult:
    workflow_name: str              # å·¥ä½œæµåç§°
    workflow_path: str              # å·¥ä½œæµæ–‡ä»¶è·¯å¾„
    goal: str                       # å·¥ä½œæµç›®æ ‡
    timestamp: str                  # æµ‹è¯•æ—¶é—´æˆ³
    success: bool                   # æ˜¯å¦æˆåŠŸ
    error_message: Optional[str]    # é”™è¯¯ä¿¡æ¯

    # éƒ¨ç½²å‰æµ‹è¯•ç»“æœ
    pre_deployment_tests: Dict[str, Any]

    # è¿è¡Œæ—¶ç›‘æ§ç»“æœ
    runtime_execution: Dict[str, Any]
    runtime_alerts: List[Dict[str, Any]]

    # ç»Ÿè®¡ä¿¡æ¯
    total_messages: int
    total_tool_calls: int
    execution_time: float
```

**WorkflowTestRunner** (ç¬¬ 83-858 è¡Œ):
- ä¸»ç¼–æ’å™¨ç±»ï¼Œè´Ÿè´£æ•´ä¸ªæµ‹è¯•æµç¨‹
- ç®¡ç†é…ç½®ã€æ—¥å¿—è¾“å‡ºã€æŠ¥å‘Šç”Ÿæˆ

---

## è¯¦ç»†æ‰§è¡Œæµç¨‹

### å‘½ä»¤è¡Œå…¥å£
```bash
python tests/evoagent_bench/test_evoagent_workflows.py
```

### å®Œæ•´æ‰§è¡Œæµç¨‹å›¾
```
[1] åˆå§‹åŒ–é˜¶æ®µ
    â”œâ”€ åŠ è½½é…ç½®æ–‡ä»¶ (config/evoagent_bench_config.yaml)
    â”œâ”€ åˆ›å»ºæ—¥å¿—ç›®å½•
    â””â”€ åˆå§‹åŒ– WorkflowTestRunner

[2] å·¥ä½œæµå‘ç°é˜¶æ®µ
    â”œâ”€ æ‰«æ workflow/ ç›®å½•
    â”œâ”€ æŸ¥æ‰¾æ‰€æœ‰ .json æ–‡ä»¶
    â””â”€ è§£æå·¥ä½œæµå…ƒæ•°æ®

[3] å¯¹æ¯ä¸ªå·¥ä½œæµæ‰§è¡Œæµ‹è¯•å¾ªç¯
    â”‚
    â”œâ”€ [3.1] è§£æå·¥ä½œæµ
    â”‚   â”œâ”€ è¯»å– JSON æ–‡ä»¶
    â”‚   â”œâ”€ æå– goal å’Œ agent é…ç½®
    â”‚   â””â”€ éªŒè¯å·¥ä½œæµç»“æ„
    â”‚
    â”œâ”€ [3.2] åˆ›å»º AG2MAS å®ä¾‹
    â”‚   â”œâ”€ è°ƒç”¨ create_ag2_mas_from_evoagentx()
    â”‚   â”œâ”€ å°† EvoAgentX æ ¼å¼è½¬æ¢ä¸º AG2 agents
    â”‚   â””â”€ æ„å»ºé¡ºåºæ™ºèƒ½ä½“è½¬æ¢é“¾
    â”‚
    â”œâ”€ [3.3] åŒ…è£… Safety_MAS
    â”‚   â”œâ”€ åˆ›å»ºå®‰å…¨åŒ…è£…å™¨
    â”‚   â””â”€ åŠ è½½æ‰€æœ‰ 20 ä¸ªé£é™©æµ‹è¯•å’Œç›‘æ§å™¨
    â”‚
    â”œâ”€ [3.4] éƒ¨ç½²å‰æµ‹è¯•ï¼ˆPre-deployment Testingï¼‰
    â”‚   â”œâ”€ é¡ºåºè¿è¡Œ 20 ä¸ªé£é™©æµ‹è¯•
    â”‚   â”‚   â”œâ”€ [1/20] (5%) Testing jailbreak...
    â”‚   â”‚   â”œâ”€ [2/20] (10%) Testing prompt_injection...
    â”‚   â”‚   â””â”€ ...
    â”‚   â”œâ”€ æ¯ä¸ªæµ‹è¯•åŠ è½½æµ‹è¯•ç”¨ä¾‹ï¼ˆtest_cases.jsonï¼‰
    â”‚   â”œâ”€ ä½¿ç”¨ Judge ç³»ç»Ÿè¯„ä¼°å“åº”
    â”‚   â””â”€ æ”¶é›†é€šè¿‡/å¤±è´¥ç»Ÿè®¡
    â”‚
    â”œâ”€ [3.5] å¯åŠ¨è¿è¡Œæ—¶ç›‘æ§
    â”‚   â”œâ”€ æ¿€æ´»é€‰å®šçš„ç›‘æ§å™¨ï¼ˆé»˜è®¤å…¨éƒ¨ 20 ä¸ªï¼‰
    â”‚   â”œâ”€ é‡ç½®ç›‘æ§å™¨çŠ¶æ€
    â”‚   â””â”€ æ³¨å†Œç›‘æ§å™¨åˆ° intermediary
    â”‚
    â”œâ”€ [3.6] æ‰§è¡Œå·¥ä½œæµ
    â”‚   â”œâ”€ ä½¿ç”¨ goal è¿è¡Œå·¥ä½œæµï¼ˆæœ€å¤š 10 è½®å¯¹è¯ï¼‰
    â”‚   â”œâ”€ é€šè¿‡å›è°ƒå‡½æ•°æ•è·æ‰§è¡Œè¿‡ç¨‹
    â”‚   â”‚   â”œâ”€ è®°å½•æ¯ä¸ªæ‰§è¡Œæ­¥éª¤
    â”‚   â”‚   â”œâ”€ è·Ÿè¸ªæ¶ˆæ¯å†å²
    â”‚   â”‚   â””â”€ ç›‘æ§å™¨å®æ—¶å¤„ç†æ¯ä¸ªæ­¥éª¤
    â”‚   â”œâ”€ æ§åˆ¶å°è¾“å‡ºæ˜¾ç¤ºè¿›åº¦
    â”‚   â””â”€ è®°å½•æ‰§è¡Œæ—¶é—´å’Œç»Ÿè®¡ä¿¡æ¯
    â”‚
    â”œâ”€ [3.7] æ”¶é›†å‘Šè­¦
    â”‚   â”œâ”€ ä»ç›‘æ§å™¨è·å–æ‰€æœ‰å‘Šè­¦
    â”‚   â”œâ”€ æŒ‰ä¸¥é‡ç¨‹åº¦åˆ†ç±»ï¼ˆcritical/warning/infoï¼‰
    â”‚   â””â”€ ä¸ºæ¯ä¸ªå‘Šè­¦æ·»åŠ å®Œæ•´ä¸Šä¸‹æ–‡
    â”‚       â”œâ”€ å‘Šè­¦å…ƒæ•°æ®ï¼ˆé£é™©ç±»å‹ã€ä¸¥é‡ç¨‹åº¦ã€æ¶ˆæ¯ï¼‰
    â”‚       â”œâ”€ æ‰§è¡Œä¸Šä¸‹æ–‡ï¼ˆæ™ºèƒ½ä½“ã€æ­¥éª¤ç´¢å¼•ï¼‰
    â”‚       â”œâ”€ ç›¸å…³æ‰§è¡Œæ­¥éª¤ï¼ˆÂ±3 æ­¥çª—å£ï¼‰
    â”‚       â”œâ”€ æ¶ˆæ¯å†å²ï¼ˆæœ€è¿‘ 10 æ¡ï¼‰
    â”‚       â””â”€ æº/ç›®æ ‡æ™ºèƒ½ä½“ä¿¡æ¯
    â”‚
    â”œâ”€ [3.8] ç”Ÿæˆæµ‹è¯•ç»“æœ
    â”‚   â”œâ”€ è®¡ç®—ç»Ÿè®¡ä¿¡æ¯
    â”‚   â”œâ”€ åˆ›å»º WorkflowTestResult å¯¹è±¡
    â”‚   â”œâ”€ ç«‹å³ä¿å­˜ JSON æ—¥å¿—
    â”‚   â””â”€ æ˜¾ç¤ºæµ‹è¯•æ‘˜è¦
    â”‚
    â””â”€ ç»§ç»­ä¸‹ä¸€ä¸ªå·¥ä½œæµ...

[4] ç”Ÿæˆæ±‡æ€»æŠ¥å‘Š
    â”œâ”€ èšåˆæ‰€æœ‰å·¥ä½œæµç»“æœ
    â”œâ”€ åˆ›å»º Markdown æŠ¥å‘Š
    â”‚   â”œâ”€ æ‰§è¡Œæ‘˜è¦
    â”‚   â”œâ”€ å•ä¸ªå·¥ä½œæµç»“æœ
    â”‚   â”œâ”€ æŒ‰ç±»åˆ«çš„é£é™©åˆ†æï¼ˆL1/L2/L3ï¼‰
    â”‚   â”œâ”€ æŒ‰é¢‘ç‡ä¼˜å…ˆçš„å»ºè®®
    â”‚   â””â”€ è¯¦ç»† JSON æ—¥å¿—é“¾æ¥
    â””â”€ ä¿å­˜æŠ¥å‘Šæ–‡ä»¶

[5] å®Œæˆ
    â””â”€ æ˜¾ç¤ºæœ€ç»ˆç»Ÿè®¡ä¿¡æ¯
```

### å•ä¸ªå·¥ä½œæµæµ‹è¯•è¯¦ç»†æµç¨‹

#### test_single_workflow() æ–¹æ³•ï¼ˆç¬¬ 270-538 è¡Œï¼‰

è¿™æ˜¯æ ¸å¿ƒæµ‹è¯•æ–¹æ³•ï¼Œå¤„ç†å•ä¸ªå·¥ä½œæµçš„å®Œæ•´æµ‹è¯•æµç¨‹ï¼š

**æ­¥éª¤ 1: è§£æå·¥ä½œæµ** (ç¬¬ 293-299 è¡Œ)
```python
# è¯»å–å·¥ä½œæµ JSON æ–‡ä»¶
with open(workflow_path, 'r', encoding='utf-8') as f:
    workflow_data = json.load(f)

# æå–ç›®æ ‡
goal = workflow_data.get("workflow", {}).get("goal", "")
```

**æ­¥éª¤ 2: åˆ›å»º AG2MAS å®ä¾‹** (ç¬¬ 301-305 è¡Œ)
```python
# ä½¿ç”¨ evoagentx_adapter åˆ›å»º MAS å®ä¾‹
mas = create_ag2_mas_from_evoagentx(
    workflow_path=str(workflow_path)
)
```
- å°† EvoAgentX JSON æ ¼å¼è½¬æ¢ä¸º AG2 agents
- æ„å»ºæ™ºèƒ½ä½“ä¹‹é—´çš„è½¬æ¢å…³ç³»

**æ­¥éª¤ 3: åŒ…è£… Safety_MAS** (ç¬¬ 307-309 è¡Œ)
```python
# åˆ›å»ºå®‰å…¨åŒ…è£…å™¨
safety_mas = Safety_MAS(mas=mas)
```
- è‡ªåŠ¨åŠ è½½æ‰€æœ‰ 20 ä¸ªé£é™©æµ‹è¯•æ¨¡å—
- è‡ªåŠ¨åŠ è½½æ‰€æœ‰ 20 ä¸ªç›‘æ§å™¨æ¨¡å—

**æ­¥éª¤ 4: è¿è¡Œéƒ¨ç½²å‰æµ‹è¯•** (ç¬¬ 311-330 è¡Œ)
```python
# é¡ºåºæµ‹è¯•æ‰€æœ‰ 20 ç§é£é™©
for idx, risk in enumerate(all_risks, 1):
    progress_pct = (idx / total_risks) * 100
    logger.info(f"[{idx}/{total_risks}] ({progress_pct:.0f}%) Testing {risk}...")

    # è¿è¡Œå•ä¸ªé£é™©æµ‹è¯•
    result = safety_mas.run_manual_safety_tests([risk])
    pre_test_results[risk] = result
```

æ¯ä¸ªé£é™©æµ‹è¯•çš„å†…éƒ¨æµç¨‹ï¼š
1. ä» `src/level3_safety/risk_tests/{risk}/test_cases.json` åŠ è½½æµ‹è¯•ç”¨ä¾‹
2. å¯¹æ¯ä¸ªæµ‹è¯•ç”¨ä¾‹ï¼š
   - å‘æ™ºèƒ½ä½“å‘é€å¯¹æŠ—æ€§è¾“å…¥
   - è·å–æ™ºèƒ½ä½“å“åº”
   - ä½¿ç”¨ Judge ç³»ç»Ÿè¯„ä¼°å“åº”æ˜¯å¦å­˜åœ¨æ¼æ´
3. æ±‡æ€»ç»“æœï¼šé€šè¿‡/å¤±è´¥çš„æµ‹è¯•ç”¨ä¾‹æ•°é‡

**æ­¥éª¤ 5: å¯åŠ¨è¿è¡Œæ—¶ç›‘æ§** (ç¬¬ 332-342 è¡Œ)
```python
# å¯åŠ¨ç›‘æ§
safety_mas.start_runtime_monitoring(
    mode=MonitorSelectionMode.MANUAL,
    selected_monitors=enabled_monitors  # é»˜è®¤å…¨éƒ¨ 20 ä¸ª
)
```

ç›‘æ§å™¨æ³¨å†Œæµç¨‹ï¼š
1. ä¸ºæ¯ä¸ªç›‘æ§å™¨åˆ›å»ºå®ä¾‹
2. å°†ç›‘æ§å™¨æ³¨å†Œåˆ° intermediary
3. ç›‘æ§å™¨å¼€å§‹ç›‘å¬ AgentStepLog äº‹ä»¶

**æ­¥éª¤ 6: æ‰§è¡Œå·¥ä½œæµ** (ç¬¬ 344-431 è¡Œ)
```python
# å®šä¹‰æ­¥éª¤æ•è·å›è°ƒ
def capture_step(log_entry):
    # è®°å½•æ‰§è¡Œæ­¥éª¤
    step_data = {
        "step": len(execution_trace) + 1,
        "timestamp": log_entry.timestamp,
        "agent": log_entry.agent_name,
        "step_type": log_entry.step_type,
        "content": str(log_entry.content),
        "metadata": log_entry.metadata
    }
    execution_trace.append(step_data)

    # è·Ÿè¸ªå¯¹è¯è½®æ¬¡
    if log_entry.step_type == "respond":
        conversation_rounds += 1
        print(f"Round {conversation_rounds}/10 - Agent: {log_entry.agent_name}")

# æ³¨å†Œå›è°ƒï¼ˆå¦‚æœæ”¯æŒï¼‰
if hasattr(safety_mas.intermediary, 'register_step_callback'):
    safety_mas.intermediary.register_step_callback(capture_step)

# æ‰§è¡Œå·¥ä½œæµ
result = safety_mas.run_task(goal, silent=True, max_rounds=10)
```

æ‰§è¡ŒæœŸé—´å‘ç”Ÿçš„äº‹æƒ…ï¼š
1. **æ™ºèƒ½ä½“äº¤äº’**: æ™ºèƒ½ä½“æŒ‰ç…§å·¥ä½œæµå®šä¹‰è¿›è¡Œå¯¹è¯
2. **æ­¥éª¤è®°å½•**: æ¯ä¸ªæ™ºèƒ½ä½“æ­¥éª¤è¢«è®°å½•ä¸º AgentStepLog
3. **å®æ—¶ç›‘æ§**: 20 ä¸ªç›‘æ§å™¨å¤„ç†æ¯ä¸ªæ­¥éª¤
4. **å‘Šè­¦ç”Ÿæˆ**: ç›‘æ§å™¨æ£€æµ‹åˆ°é£é™©æ—¶ç”Ÿæˆå‘Šè­¦
5. **è¿›åº¦æ˜¾ç¤º**: æ§åˆ¶å°æ˜¾ç¤ºå½“å‰å¯¹è¯è½®æ¬¡

**æ­¥éª¤ 7: æ”¶é›†å‘Šè­¦** (ç¬¬ 433-476 è¡Œ)
```python
# è·å–æ‰€æœ‰å‘Šè­¦
alerts = safety_mas.get_alerts()

# ä¸ºæ¯ä¸ªå‘Šè­¦æ·»åŠ å®Œæ•´ä¸Šä¸‹æ–‡
for i, alert in enumerate(alerts):
    alert_context = {
        "alert_id": f"alert_{i+1:03d}",
        "risk_type": alert.risk_type,
        "severity": alert.severity,
        "message": alert.message,
        "evidence": alert.evidence,
        "recommended_action": alert.recommended_action,

        "context": {
            "agent_name": alert.agent_name,
            "step_index": alert.step_index,

            # åŒ…å«ç›¸å…³æ‰§è¡Œæ­¥éª¤ï¼ˆå‰å 3 æ­¥ï¼‰
            "related_steps": self._get_related_steps(
                execution_trace, alert.step_index
            ),

            # åŒ…å«æ¶ˆæ¯å†å²ï¼ˆæœ€è¿‘ 10 æ¡ï¼‰
            "message_history": message_history[-10:]
        }
    }
    alert_dicts.append(alert_context)
```

å‘Šè­¦ä¸Šä¸‹æ–‡åŒ…å«ï¼š
- **å‘Šè­¦å…ƒæ•°æ®**: é£é™©ç±»å‹ã€ä¸¥é‡ç¨‹åº¦ã€æ¶ˆæ¯ã€è¯æ®
- **æ‰§è¡Œä¸Šä¸‹æ–‡**: è§¦å‘å‘Šè­¦çš„æ™ºèƒ½ä½“ã€æ­¥éª¤ç´¢å¼•
- **ç›¸å…³æ­¥éª¤**: å‘Šè­¦å‰å 3 æ­¥çš„æ‰§è¡Œè®°å½•
- **æ¶ˆæ¯å†å²**: æœ€è¿‘ 10 æ¡æ¶ˆæ¯ï¼Œæä¾›å¯¹è¯ä¸Šä¸‹æ–‡
- **æ™ºèƒ½ä½“ä¿¡æ¯**: æºæ™ºèƒ½ä½“å’Œç›®æ ‡æ™ºèƒ½ä½“

**æ­¥éª¤ 8: ç”Ÿæˆæµ‹è¯•ç»“æœ** (ç¬¬ 478-523 è¡Œ)
```python
# åˆ›å»ºå®Œæ•´çš„æµ‹è¯•ç»“æœå¯¹è±¡
test_result = WorkflowTestResult(
    workflow_name=workflow_name,
    workflow_path=str(workflow_path),
    goal=goal,
    timestamp=timestamp,
    success=True,

    # éƒ¨ç½²å‰æµ‹è¯•ç»“æœï¼ˆæ ¼å¼åŒ–åï¼‰
    pre_deployment_tests=self._format_pre_test_results(pre_test_results),

    # è¿è¡Œæ—¶æ‰§è¡Œæ•°æ®
    runtime_execution={
        "workflow_steps": execution_trace,
        "message_history": message_history,
        "result": str(result.output),
        "success": result.success
    },

    # è¿è¡Œæ—¶å‘Šè­¦ï¼ˆå¸¦å®Œæ•´ä¸Šä¸‹æ–‡ï¼‰
    runtime_alerts=alert_dicts,

    # ç»Ÿè®¡ä¿¡æ¯
    total_messages=total_messages,
    total_tool_calls=total_tool_calls,
    execution_time=execution_time
)

# ç«‹å³ä¿å­˜ JSON æ—¥å¿—
self.save_workflow_log(test_result)
```

---

## å…³é”®ç»„ä»¶è¯´æ˜

### 1. WorkflowTestRunnerï¼ˆæµ‹è¯•ç¼–æ’å™¨ï¼‰

**èŒè´£**:
- ç®¡ç†æ•´ä¸ªæµ‹è¯•æµç¨‹çš„ç”Ÿå‘½å‘¨æœŸ
- åŠ è½½å’Œç®¡ç†é…ç½®
- å‘ç°å’Œç¼–æ’å·¥ä½œæµæµ‹è¯•
- ç”Ÿæˆæ—¥å¿—å’ŒæŠ¥å‘Š

**å…³é”®æ–¹æ³•**:
- `__init__(config_path)`: åˆå§‹åŒ–ï¼ŒåŠ è½½é…ç½®
- `discover_workflows()`: å‘ç°å·¥ä½œæµæ–‡ä»¶
- `test_single_workflow()`: æµ‹è¯•å•ä¸ªå·¥ä½œæµ
- `run_all_tests()`: è¿è¡Œæ‰€æœ‰å·¥ä½œæµæµ‹è¯•
- `save_workflow_log()`: ä¿å­˜å•ä¸ªå·¥ä½œæµæ—¥å¿—
- `generate_summary_report()`: ç”Ÿæˆæ±‡æ€»æŠ¥å‘Š

### 2. Safety_MASï¼ˆå®‰å…¨åŒ…è£…å™¨ï¼‰

**ä½ç½®**: `src/level3_safety/safety_mas.py`

**èŒè´£**:
- åŒ…è£…åŸå§‹ MAS å®ä¾‹
- æä¾›éƒ¨ç½²å‰æµ‹è¯•æ¥å£
- æä¾›è¿è¡Œæ—¶ç›‘æ§æ¥å£
- ç®¡ç†å‘Šè­¦æ”¶é›†

**å…³é”®æ–¹æ³•**:
- `run_manual_safety_tests(risk_names)`: è¿è¡ŒæŒ‡å®šçš„é£é™©æµ‹è¯•
- `start_runtime_monitoring(mode, selected_monitors)`: å¯åŠ¨ç›‘æ§
- `run_task(goal, ...)`: æ‰§è¡Œå·¥ä½œæµä»»åŠ¡
- `get_alerts()`: è·å–æ‰€æœ‰å‘Šè­¦

### 3. é£é™©æµ‹è¯•æ¨¡å—

**ä½ç½®**: `src/level3_safety/risk_tests/{risk_name}/`

**ç»“æ„**:
```
risk_tests/
â”œâ”€â”€ l1_jailbreak/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ test.py              # æµ‹è¯•é€»è¾‘
â”‚   â””â”€â”€ test_cases.json      # æµ‹è¯•ç”¨ä¾‹
â”œâ”€â”€ l1_prompt_injection/
â”‚   â””â”€â”€ ...
â””â”€â”€ ...
```

**æµ‹è¯•æµç¨‹**:
1. åŠ è½½ `test_cases.json` ä¸­çš„æµ‹è¯•ç”¨ä¾‹
2. å¯¹æ¯ä¸ªæµ‹è¯•ç”¨ä¾‹ï¼š
   - æ„é€ å¯¹æŠ—æ€§è¾“å…¥
   - å‘é€ç»™æ™ºèƒ½ä½“
   - è·å–å“åº”
   - ä½¿ç”¨ Judge è¯„ä¼°å“åº”
3. è¿”å›æµ‹è¯•ç»“æœï¼ˆé€šè¿‡/å¤±è´¥ç»Ÿè®¡ï¼‰

### 4. ç›‘æ§å™¨æ¨¡å—

**ä½ç½®**: `src/level3_safety/monitor_agents/{risk_name}/`

**ç»“æ„**:
```
monitor_agents/
â”œâ”€â”€ l1_jailbreak/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â””â”€â”€ monitor.py           # ç›‘æ§é€»è¾‘
â”œâ”€â”€ l1_prompt_injection/
â”‚   â””â”€â”€ ...
â””â”€â”€ ...
```

**ç›‘æ§æµç¨‹**:
1. æ³¨å†Œåˆ° intermediaryï¼Œç›‘å¬ AgentStepLog äº‹ä»¶
2. å¯¹æ¯ä¸ªæ‰§è¡Œæ­¥éª¤ï¼š
   - åˆ†ææ­¥éª¤å†…å®¹
   - æ£€æµ‹æ˜¯å¦å­˜åœ¨é£é™©ç‰¹å¾
   - å¦‚æœæ£€æµ‹åˆ°é£é™©ï¼Œç”Ÿæˆå‘Šè­¦
3. å‘Šè­¦åŒ…å«ï¼š
   - é£é™©ç±»å‹
   - ä¸¥é‡ç¨‹åº¦ï¼ˆcritical/warning/infoï¼‰
   - æè¿°æ¶ˆæ¯
   - è¯æ®
   - å»ºè®®çš„ç¼“è§£æªæ–½

### 5. Judge ç³»ç»Ÿ

**ä½ç½®**: `src/level3_safety/judges/`

**ç±»å‹**:
- **LLM Judge**: ä½¿ç”¨ GPT/Claude è¿›è¡Œæ™ºèƒ½åˆ†æ
- **Pattern Judge**: ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼è¿›è¡Œæ¨¡å¼åŒ¹é…

**å·¥ä½œæµç¨‹**:
```python
# åˆ›å»º Judge
judge = JudgeFactory.create_judge(
    judge_type="llm",  # æˆ– "pattern"
    risk_type="jailbreak"
)

# è¯„ä¼°å“åº”
result = judge.evaluate(
    agent_response="...",
    test_case="..."
)

# ç»“æœåŒ…å«
{
    "is_vulnerable": True/False,
    "confidence": 0.0-1.0,
    "reasoning": "...",
    "evidence": "..."
}
```

### 6. EvoAgentX Adapter

**ä½ç½®**: `src/level1_framework/evoagentx_adapter.py`

**èŒè´£**:
- è§£æ EvoAgentX JSON å·¥ä½œæµæ ¼å¼
- è½¬æ¢ä¸º AG2MAS å®ä¾‹
- æ„å»ºæ™ºèƒ½ä½“è½¬æ¢é“¾

**è½¬æ¢æµç¨‹**:
```python
def create_ag2_mas_from_evoagentx(workflow_path):
    # 1. è§£æ JSON
    workflow_data = parse_workflow_json(workflow_path)

    # 2. åˆ›å»º AG2 agents
    agents = []
    for node in workflow_data["workflow"]["nodes"]:
        agent = create_ag2_agent(
            name=node["name"],
            system_prompt=node["system_prompt"],
            llm_config=node.get("llm_config", {})
        )
        agents.append(agent)

    # 3. æ„å»ºè½¬æ¢é“¾
    transitions = build_transitions(agents)

    # 4. åˆ›å»º AG2MAS å®ä¾‹
    mas = AG2MAS(agents=agents, transitions=transitions)

    return mas
```

---

## è¾“å‡ºç»“æ„

### å•ä¸ªå·¥ä½œæµ JSON æ—¥å¿—

**æ–‡ä»¶åæ ¼å¼**: `{workflow_name}_{timestamp}.json`

**ç¤ºä¾‹**: `my_workflow_20260204_183000.json`

**ç»“æ„**:
```json
{
  "workflow_name": "my_workflow",
  "workflow_path": "/path/to/workflow.json",
  "goal": "Analyze document and generate summary",
  "timestamp": "2026-02-04T18:30:00",
  "success": true,
  "error_message": null,

  "pre_deployment_tests": {
    "summary": {
      "total": 20,
      "passed": 18,
      "failed": 2,
      "pass_rate": 90.0,
      "use_llm_judge": true
    },
    "l1_risks": {
      "jailbreak": {
        "passed": true,
        "total_cases": 10,
        "passed_cases": 10,
        "failed_cases": 0,
        "details": [...]
      },
      ...
    },
    "l2_risks": {...},
    "l3_risks": {...}
  },

  "runtime_execution": {
    "workflow_steps": [
      {
        "step": 1,
        "timestamp": "2026-02-04T18:30:05",
        "agent": "agent1",
        "step_type": "receive",
        "content": "...",
        "metadata": {}
      },
      ...
    ],
    "message_history": [
      {
        "agent": "agent1",
        "content": "...",
        "timestamp": "2026-02-04T18:30:05"
      },
      ...
    ],
    "result": "Task completed successfully",
    "success": true
  },

  "runtime_alerts": [
    {
      "alert_id": "alert_001",
      "risk_type": "prompt_injection",
      "severity": "warning",
      "message": "Potential prompt injection detected",
      "evidence": {...},
      "recommended_action": "Review and sanitize input",
      "timestamp": "2026-02-04T18:30:10",

      "context": {
        "agent_name": "agent2",
        "step_index": 15,
        "source_agent": "agent1",
        "target_agent": "agent2",
        "source_message": "...",

        "related_steps": [
          // å‰å 3 æ­¥çš„æ‰§è¡Œè®°å½•
        ],

        "message_history": [
          // æœ€è¿‘ 10 æ¡æ¶ˆæ¯
        ]
      }
    },
    ...
  ],

  "total_messages": 25,
  "total_tool_calls": 5,
  "execution_time": 45.2
}
```

### Markdown æ±‡æ€»æŠ¥å‘Š

**æ–‡ä»¶åæ ¼å¼**: `summary_report_{timestamp}.md`

**ç¤ºä¾‹**: `summary_report_20260204_183100.md`

**ç»“æ„**:
```markdown
# EvoAgent Workflow Security Testing Report

**Generated**: 2026-02-04 18:31:00

## Executive Summary

- **Total Workflows Tested**: 5
- **Successful**: 5
- **Failed**: 0
- **Total Execution Time**: 225.5s

- **Total Runtime Alerts**: 12
  - Critical: 2
  - Warning: 7
  - Info: 3

## Workflow Results

### 1. my_workflow âœ…

- **Goal**: Analyze document and generate summary
- **Status**: Success
- **Execution Time**: 45.2s
- **Pre-deployment Tests**: 18/20 passed (90.0%)
- **Runtime Alerts**: 3 (0 critical, 2 warning, 1 info)

**Key Risks Detected**:
- âš ï¸ prompt_injection: 2 alert(s)
- â„¹ï¸ hallucination: 1 alert(s)

**Failed Pre-deployment Tests**:
- code_execution
- sandbox_escape

[ğŸ“„ Detailed Log](my_workflow_20260204_183000.json)

---

### 2. another_workflow âœ…
...

## Risk Analysis by Category

### L1 Risks (Single-Agent)

| Risk | Workflows Affected | Pre-test Pass Rate | Runtime Alerts |
|------|-------------------|-------------------|----------------|
| jailbreak | 0/5 (0%) | 100% | 0 |
| prompt_injection | 2/5 (40%) | 80% | 5 |
| sensitive_disclosure | 1/5 (20%) | 90% | 2 |
| ... | ... | ... | ... |

### L2 Risks (Inter-Agent)
...

### L3 Risks (System-Level)
...

## Recommendations

### High Priority

1. **prompt_injection**: Detected 5 times across workflows. Review and implement mitigation strategies.

2. **sensitive_disclosure**: Detected 2 times across workflows. Review and implement mitigation strategies.

### Medium Priority

1. **hallucination**: Detected 1 times. Monitor and address as needed.

## Conclusion

The testing identified 2 critical security concerns that require immediate attention. Additionally, 7 warnings were raised that should be reviewed. Detailed logs for each workflow are available in the individual JSON files.
```

---

## é…ç½®é€‰é¡¹

### é…ç½®æ–‡ä»¶ä½ç½®
`config/evoagent_bench_config.yaml`

### å®Œæ•´é…ç½®ç¤ºä¾‹
```yaml
# ç›‘æ§é…ç½®
monitoring:
  # å¯ç”¨çš„ç›‘æ§å™¨åˆ—è¡¨ï¼ˆé»˜è®¤ï¼šå…¨éƒ¨ 20 ä¸ªï¼‰
  enabled_monitors:
    # L1 é£é™©
    - jailbreak
    - prompt_injection
    - sensitive_disclosure
    - excessive_agency
    - code_execution
    - hallucination
    - memory_poisoning
    - tool_misuse
    # L2 é£é™©
    - message_tampering
    - malicious_propagation
    - misinformation_amplify
    - insecure_output
    - goal_drift
    - identity_spoofing
    # L3 é£é™©
    - cascading_failures
    - sandbox_escape
    - insufficient_monitoring
    - group_hallucination
    - malicious_emergence
    - rogue_agent

# æµ‹è¯•é…ç½®
testing:
  # ä½¿ç”¨ LLM Judge è¿›è¡Œæ›´å‡†ç¡®çš„ç»“æœï¼ˆtrueï¼‰æˆ–ä½¿ç”¨å¯å‘å¼è§„åˆ™ï¼ˆfalseï¼‰
  use_llm_judge: true

  # å¦‚æœä¸€ä¸ªå·¥ä½œæµå¤±è´¥ï¼Œæ˜¯å¦ç»§ç»­æµ‹è¯•å…¶ä»–å·¥ä½œæµ
  continue_on_error: true

  # æ—¥å¿—è¯¦ç»†ç¨‹åº¦ï¼šdetailed | medium | summary
  log_level: "detailed"

  # æ¯ä¸ªå·¥ä½œæµçš„è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼Œ0 = æ— è¶…æ—¶ï¼‰
  workflow_timeout: 300

# è¾“å‡ºé…ç½®
output:
  # æ—¥å¿—è¾“å‡ºç›®å½•
  log_dir: "tests/evoagent_bench/logs"

  # åœ¨æ–‡ä»¶åä¸­åŒ…å«æ—¶é—´æˆ³
  use_timestamps: true

  # ç¾åŒ– JSON è¾“å‡ºï¼ˆæ›´æ˜“è¯»ï¼‰
  pretty_json: true

  # ç”Ÿæˆ Markdown æ±‡æ€»æŠ¥å‘Š
  generate_summary: true
```

### é…ç½®é¡¹è¯´æ˜

#### monitoring.enabled_monitors
- **ç±»å‹**: åˆ—è¡¨
- **é»˜è®¤å€¼**: å…¨éƒ¨ 20 ä¸ªç›‘æ§å™¨
- **è¯´æ˜**: æŒ‡å®šè¦å¯ç”¨çš„ç›‘æ§å™¨ã€‚å¯ä»¥é€‰æ‹©æ€§å¯ç”¨éƒ¨åˆ†ç›‘æ§å™¨ä»¥æé«˜æ€§èƒ½æˆ–ä¸“æ³¨äºç‰¹å®šé£é™©ã€‚

#### testing.use_llm_judge
- **ç±»å‹**: å¸ƒå°”å€¼
- **é»˜è®¤å€¼**: true
- **è¯´æ˜**:
  - `true`: ä½¿ç”¨ LLMï¼ˆGPT/Claudeï¼‰è¿›è¡Œæ™ºèƒ½åˆ†æï¼Œæ›´å‡†ç¡®ä½†è¾ƒæ…¢ä¸”éœ€è¦ API è°ƒç”¨
  - `false`: ä½¿ç”¨å¯å‘å¼è§„åˆ™ï¼ˆæ­£åˆ™è¡¨è¾¾å¼ï¼‰ï¼Œæ›´å¿«ä½†å¯èƒ½ä¸å¤Ÿå‡†ç¡®

#### testing.continue_on_error
- **ç±»å‹**: å¸ƒå°”å€¼
- **é»˜è®¤å€¼**: true
- **è¯´æ˜**:
  - `true`: å³ä½¿æŸä¸ªå·¥ä½œæµæµ‹è¯•å¤±è´¥ï¼Œç»§ç»­æµ‹è¯•å…¶ä»–å·¥ä½œæµ
  - `false`: é‡åˆ°ç¬¬ä¸€ä¸ªå¤±è´¥å°±åœæ­¢æ•´ä¸ªæµ‹è¯•æµç¨‹

#### testing.log_level
- **ç±»å‹**: å­—ç¬¦ä¸²
- **å¯é€‰å€¼**: "detailed" | "medium" | "summary"
- **é»˜è®¤å€¼**: "detailed"
- **è¯´æ˜**: æ§åˆ¶æ—¥å¿—çš„è¯¦ç»†ç¨‹åº¦

#### testing.workflow_timeout
- **ç±»å‹**: æ•´æ•°ï¼ˆç§’ï¼‰
- **é»˜è®¤å€¼**: 300
- **è¯´æ˜**: å•ä¸ªå·¥ä½œæµæ‰§è¡Œçš„æœ€å¤§æ—¶é—´ã€‚0 è¡¨ç¤ºæ— è¶…æ—¶é™åˆ¶ã€‚

#### output.log_dir
- **ç±»å‹**: å­—ç¬¦ä¸²
- **é»˜è®¤å€¼**: "tests/evoagent_bench/logs"
- **è¯´æ˜**: æ—¥å¿—æ–‡ä»¶çš„è¾“å‡ºç›®å½•

#### output.use_timestamps
- **ç±»å‹**: å¸ƒå°”å€¼
- **é»˜è®¤å€¼**: true
- **è¯´æ˜**:
  - `true`: æ–‡ä»¶ååŒ…å«æ—¶é—´æˆ³ï¼Œå¦‚ `workflow_20260204_183000.json`
  - `false`: æ–‡ä»¶åä¸åŒ…å«æ—¶é—´æˆ³ï¼Œå¦‚ `workflow.json`ï¼ˆä¼šè¦†ç›–ä¹‹å‰çš„æ–‡ä»¶ï¼‰

#### output.pretty_json
- **ç±»å‹**: å¸ƒå°”å€¼
- **é»˜è®¤å€¼**: true
- **è¯´æ˜**:
  - `true`: JSON æ–‡ä»¶æ ¼å¼åŒ–è¾“å‡ºï¼Œå¸¦ç¼©è¿›ï¼Œæ˜“äºé˜…è¯»
  - `false`: JSON æ–‡ä»¶ç´§å‡‘è¾“å‡ºï¼Œæ–‡ä»¶æ›´å°

#### output.generate_summary
- **ç±»å‹**: å¸ƒå°”å€¼
- **é»˜è®¤å€¼**: true
- **è¯´æ˜**: æ˜¯å¦ç”Ÿæˆ Markdown æ±‡æ€»æŠ¥å‘Š

### LLM é…ç½®

ç³»ç»Ÿä½¿ç”¨ä¸¤ä¸ªç‹¬ç«‹çš„ LLM é…ç½®æ–‡ä»¶ï¼š

1. **MAS Agent LLM é…ç½®**: `config/mas_llm_config.yaml`
   - ç”¨äºå·¥ä½œæµä¸­çš„æ™ºèƒ½ä½“
   - é…ç½®æ™ºèƒ½ä½“ä½¿ç”¨çš„ LLM æ¨¡å‹å’Œå‚æ•°

2. **Monitor LLM é…ç½®**: `config/monitor_llm_config.yaml`
   - ç”¨äºç›‘æ§å™¨å’Œ Judge ç³»ç»Ÿ
   - é…ç½®å®‰å…¨åˆ†æä½¿ç”¨çš„ LLM æ¨¡å‹å’Œå‚æ•°

---

## ä½¿ç”¨ç¤ºä¾‹

### åŸºæœ¬ä½¿ç”¨

#### 1. æµ‹è¯•æ‰€æœ‰å·¥ä½œæµï¼ˆé»˜è®¤é…ç½®ï¼‰
```bash
python tests/evoagent_bench/test_evoagent_workflows.py
```

**æ•ˆæœ**:
- æ‰«æ `workflow/` ç›®å½•ä¸‹çš„æ‰€æœ‰ `.json` æ–‡ä»¶
- å¯¹æ¯ä¸ªå·¥ä½œæµè¿è¡Œå®Œæ•´çš„å®‰å…¨æµ‹è¯•
- ä½¿ç”¨ LLM Judge è¿›è¡Œåˆ†æ
- å¯ç”¨æ‰€æœ‰ 20 ä¸ªç›‘æ§å™¨
- ç”Ÿæˆè¯¦ç»†çš„ JSON æ—¥å¿—å’Œ Markdown æ±‡æ€»æŠ¥å‘Š

#### 2. æµ‹è¯•ç‰¹å®šå·¥ä½œæµ
```bash
python tests/evoagent_bench/test_evoagent_workflows.py \
    --workflows my_workflow.json another_workflow.json
```

**æ•ˆæœ**:
- åªæµ‹è¯•æŒ‡å®šçš„å·¥ä½œæµæ–‡ä»¶
- å…¶ä»–é…ç½®ä½¿ç”¨é»˜è®¤å€¼

#### 3. ä½¿ç”¨å¯å‘å¼è§„åˆ™ï¼ˆæ›´å¿«ï¼‰
```bash
python tests/evoagent_bench/test_evoagent_workflows.py --no-llm-judge
```

**æ•ˆæœ**:
- ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼è¿›è¡Œæ¨¡å¼åŒ¹é…ï¼Œä¸è°ƒç”¨ LLM API
- æµ‹è¯•é€Ÿåº¦æ›´å¿«ï¼Œæˆæœ¬æ›´ä½
- å‡†ç¡®æ€§å¯èƒ½ç•¥ä½äº LLM Judge

#### 4. è‡ªå®šä¹‰è¾“å‡ºç›®å½•
```bash
python tests/evoagent_bench/test_evoagent_workflows.py \
    --output-dir ./my_custom_logs
```

**æ•ˆæœ**:
- æ—¥å¿—æ–‡ä»¶ä¿å­˜åˆ°æŒ‡å®šç›®å½•
- è¦†ç›–é…ç½®æ–‡ä»¶ä¸­çš„ `output.log_dir` è®¾ç½®

#### 5. åªå¯ç”¨ç‰¹å®šç›‘æ§å™¨
```bash
python tests/evoagent_bench/test_evoagent_workflows.py \
    --monitors jailbreak prompt_injection sensitive_disclosure
```

**æ•ˆæœ**:
- åªå¯ç”¨æŒ‡å®šçš„ 3 ä¸ªç›‘æ§å™¨
- éƒ¨ç½²å‰æµ‹è¯•ä»ç„¶è¿è¡Œå…¨éƒ¨ 20 ä¸ªé£é™©æµ‹è¯•
- è¿è¡Œæ—¶åªç›‘æ§æŒ‡å®šçš„ 3 ç§é£é™©

#### 6. å¹²è¿è¡Œï¼ˆæŸ¥çœ‹æµ‹è¯•è®¡åˆ’ï¼‰
```bash
python tests/evoagent_bench/test_evoagent_workflows.py --dry-run
```

**æ•ˆæœ**:
- æ˜¾ç¤ºå°†è¦æµ‹è¯•çš„å·¥ä½œæµåˆ—è¡¨
- æ˜¾ç¤ºé…ç½®ä¿¡æ¯
- ä¸å®é™…æ‰§è¡Œæµ‹è¯•

#### 7. ä½¿ç”¨è‡ªå®šä¹‰é…ç½®æ–‡ä»¶
```bash
python tests/evoagent_bench/test_evoagent_workflows.py \
    --config config/my_custom_config.yaml
```

**æ•ˆæœ**:
- ä½¿ç”¨æŒ‡å®šçš„é…ç½®æ–‡ä»¶è€Œä¸æ˜¯é»˜è®¤çš„ `config/evoagent_bench_config.yaml`

### é«˜çº§ä½¿ç”¨åœºæ™¯

#### åœºæ™¯ 1: å¿«é€Ÿå®‰å…¨æ‰«æ
```bash
# ä½¿ç”¨å¯å‘å¼è§„åˆ™ï¼Œåªç›‘æ§é«˜é£é™©é¡¹
python tests/evoagent_bench/test_evoagent_workflows.py \
    --no-llm-judge \
    --monitors jailbreak prompt_injection code_execution sandbox_escape
```

**é€‚ç”¨äº**:
- å¿«é€Ÿè¿­ä»£å¼€å‘
- CI/CD æµæ°´çº¿
- åˆæ­¥å®‰å…¨æ£€æŸ¥

#### åœºæ™¯ 2: æ·±åº¦å®‰å…¨å®¡è®¡
```bash
# ä½¿ç”¨ LLM Judgeï¼Œå¯ç”¨æ‰€æœ‰ç›‘æ§å™¨ï¼Œè¯¦ç»†æ—¥å¿—
python tests/evoagent_bench/test_evoagent_workflows.py \
    --output-dir ./security_audit_$(date +%Y%m%d)
```

**é€‚ç”¨äº**:
- ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²å‰
- å®‰å…¨åˆè§„å®¡è®¡
- æ·±åº¦æ¼æ´åˆ†æ

#### åœºæ™¯ 3: ç‰¹å®šé£é™©ç±»åˆ«æµ‹è¯•
```bash
# åªæµ‹è¯• L1 å•æ™ºèƒ½ä½“é£é™©
python tests/evoagent_bench/test_evoagent_workflows.py \
    --monitors jailbreak prompt_injection sensitive_disclosure \
              excessive_agency code_execution hallucination \
              memory_poisoning tool_misuse
```

**é€‚ç”¨äº**:
- ä¸“æ³¨äºç‰¹å®šé£é™©ç±»åˆ«
- åˆ†é˜¶æ®µå®‰å…¨æµ‹è¯•
- æ€§èƒ½ä¼˜åŒ–

#### åœºæ™¯ 4: æŒç»­é›†æˆï¼ˆCIï¼‰
```bash
#!/bin/bash
# ci_security_test.sh

# è®¾ç½®ç¯å¢ƒå˜é‡
export OPENAI_API_KEY="your-api-key"

# è¿è¡Œæµ‹è¯•
python tests/evoagent_bench/test_evoagent_workflows.py \
    --no-llm-judge \
    --output-dir ./ci_logs \
    --workflows production_workflow.json

# æ£€æŸ¥ç»“æœ
if [ $? -eq 0 ]; then
    echo "Security tests passed"
    exit 0
else
    echo "Security tests failed"
    exit 1
fi
```

**é€‚ç”¨äº**:
- GitHub Actions / GitLab CI
- è‡ªåŠ¨åŒ–æµ‹è¯•æµæ°´çº¿
- æ¯æ¬¡æäº¤çš„å®‰å…¨æ£€æŸ¥

### è¾“å‡ºç¤ºä¾‹

#### æ§åˆ¶å°è¾“å‡ºç¤ºä¾‹
```
======================================================================
  EvoAgent Workflow Security Testing
======================================================================

======================================================================
Starting tests for 2 workflow(s)
======================================================================

######################################################################
WORKFLOW 1/2 (50%): my_workflow.json
######################################################################

======================================================================
Testing workflow: my_workflow
======================================================================
Step 1: Parsing workflow...
Goal: Analyze document and generate summary

Step 2: Creating AG2MAS instance...

Step 3: Wrapping with Safety_MAS...

Step 4: Running pre-deployment tests (20 risks)...
  [1/20] (5%) Testing jailbreak...
  [2/20] (10%) Testing prompt_injection...
  [3/20] (15%) Testing sensitive_disclosure...
  ...
  [20/20] (100%) Testing rogue_agent...

Step 5: Starting runtime monitoring...
  Enabled monitors: 20

Step 6: Executing workflow with goal: Analyze document and generate summary
  (Max 10 rounds of conversation, monitoring in progress...)

======================================================================
WORKFLOW EXECUTION STARTED: my_workflow
Goal: Analyze document and generate summary
Max rounds: 10
======================================================================

  >>> Round 1/10 - Agent: agent1
  >>> Round 2/10 - Agent: agent2
  >>> Round 3/10 - Agent: agent1
  ...

======================================================================
ğŸ WORKFLOW EXECUTION COMPLETED: my_workflow
======================================================================
Execution time: 45.20s
Conversation rounds: 5
Total execution steps: 23
Total messages: 15
======================================================================

Step 7: Collecting alerts with full context...
  Total alerts: 3 (Critical: 0, Warning: 2, Info: 1)

======================================================================
âœ… Workflow test completed successfully in 52.30s
======================================================================
Pre-deployment: 18/20 tests passed
Runtime alerts: 3 total (0 critical, 2 warning, 1 info)
======================================================================

Saved workflow log: tests/evoagent_bench/logs/my_workflow_20260204_183000.json

âœ… Workflow 1/2 completed in 52.30s

######################################################################
WORKFLOW 2/2 (100%): another_workflow.json
######################################################################
...

======================================================================
All tests completed: 2/2 workflows tested
======================================================================

Generated summary report: tests/evoagent_bench/logs/summary_report_20260204_183100.md

======================================================================
âœ… Testing complete!
Results saved to: tests/evoagent_bench/logs
Total workflows tested: 2
Successful: 2
Failed: 0
======================================================================
```

### æ•…éšœæ’æŸ¥

#### é—®é¢˜ 1: æ‰¾ä¸åˆ°å·¥ä½œæµ
```
ERROR: No workflows found to test
```

**è§£å†³æ–¹æ¡ˆ**:
- ç¡®ä¿ `workflow/` ç›®å½•å­˜åœ¨
- ç¡®ä¿ç›®å½•ä¸­æœ‰ `.json` æ–‡ä»¶
- éªŒè¯ JSON æ–‡ä»¶æ ¼å¼æ­£ç¡®
- ä½¿ç”¨ `--workflow-dir` æŒ‡å®šæ­£ç¡®çš„ç›®å½•

#### é—®é¢˜ 2: LLM API é”™è¯¯
```
ERROR: OpenAI API key not found
```

**è§£å†³æ–¹æ¡ˆ**:
- è®¾ç½®ç¯å¢ƒå˜é‡: `export OPENAI_API_KEY="your-key"`
- æˆ–åœ¨é…ç½®æ–‡ä»¶ä¸­è®¾ç½® API å¯†é’¥
- æˆ–ä½¿ç”¨ `--no-llm-judge` è·³è¿‡ LLM è°ƒç”¨

#### é—®é¢˜ 3: æµ‹è¯•è¶…æ—¶
```
ERROR: Workflow execution timeout after 300s
```

**è§£å†³æ–¹æ¡ˆ**:
- å¢åŠ  `workflow_timeout` é…ç½®å€¼
- æˆ–ä½¿ç”¨ `--workflow-timeout 600` å‘½ä»¤è¡Œå‚æ•°
- æ£€æŸ¥å·¥ä½œæµæ˜¯å¦å­˜åœ¨æ­»å¾ªç¯

#### é—®é¢˜ 4: å†…å­˜ä¸è¶³
```
ERROR: Out of memory
```

**è§£å†³æ–¹æ¡ˆ**:
- å‡å°‘å¯ç”¨çš„ç›‘æ§å™¨æ•°é‡
- ä½¿ç”¨ `--no-llm-judge` å‡å°‘å†…å­˜ä½¿ç”¨
- åˆ†æ‰¹æµ‹è¯•å·¥ä½œæµ
- å¢åŠ ç³»ç»Ÿå†…å­˜

#### é—®é¢˜ 5: æ²¡æœ‰ç”Ÿæˆå‘Šè­¦
```
WARNING: No alerts generated during monitoring
```

**å¯èƒ½åŸå› **:
- å·¥ä½œæµæœ¬èº«å¾ˆå®‰å…¨ï¼Œæ²¡æœ‰è§¦å‘é£é™©
- ç›‘æ§å™¨æœªæ­£ç¡®å¯ç”¨
- LLM Judge é…ç½®é—®é¢˜

**æ£€æŸ¥æ–¹æ³•**:
- æŸ¥çœ‹é…ç½®æ–‡ä»¶ä¸­çš„ `enabled_monitors`
- æ£€æŸ¥ `use_llm_judge` è®¾ç½®
- æŸ¥çœ‹è¯¦ç»†æ—¥å¿—äº†è§£ç›‘æ§å™¨çŠ¶æ€

---

## æ€»ç»“

### æ ¸å¿ƒæµç¨‹å›é¡¾
1. **åˆå§‹åŒ–**: åŠ è½½é…ç½®ï¼Œåˆ›å»ºæ—¥å¿—ç›®å½•
2. **å‘ç°å·¥ä½œæµ**: æ‰«æå¹¶è§£æå·¥ä½œæµæ–‡ä»¶
3. **å¯¹æ¯ä¸ªå·¥ä½œæµ**:
   - è§£æå¹¶è½¬æ¢ä¸º AG2MAS å®ä¾‹
   - è¿è¡Œ 20 ä¸ªéƒ¨ç½²å‰æµ‹è¯•
   - å¯åŠ¨ 20 ä¸ªè¿è¡Œæ—¶ç›‘æ§å™¨
   - æ‰§è¡Œå·¥ä½œæµï¼ˆæœ€å¤š 10 è½®å¯¹è¯ï¼‰
   - æ”¶é›†å‘Šè­¦å¹¶æ·»åŠ å®Œæ•´ä¸Šä¸‹æ–‡
   - ç”Ÿæˆè¯¦ç»†çš„ JSON æ—¥å¿—
4. **ç”Ÿæˆæ±‡æ€»æŠ¥å‘Š**: èšåˆæ‰€æœ‰ç»“æœï¼Œç”Ÿæˆ Markdown æŠ¥å‘Š

### å…³é”®ç‰¹æ€§
- âœ… **å…¨é¢è¦†ç›–**: 20 ç§å®‰å…¨é£é™©ï¼ŒL1/L2/L3 ä¸‰ä¸ªå±‚çº§
- âœ… **åŒé‡ä¿éšœ**: éƒ¨ç½²å‰æµ‹è¯• + è¿è¡Œæ—¶ç›‘æ§
- âœ… **æ™ºèƒ½åˆ†æ**: LLM Judge æˆ–å¯å‘å¼è§„åˆ™
- âœ… **è¯¦ç»†ä¸Šä¸‹æ–‡**: æ¯ä¸ªå‘Šè­¦åŒ…å«å®Œæ•´çš„æ‰§è¡Œä¸Šä¸‹æ–‡
- âœ… **çµæ´»é…ç½®**: æ”¯æŒå¤šç§é…ç½®é€‰é¡¹å’Œå‘½ä»¤è¡Œå‚æ•°
- âœ… **æ˜“äºé›†æˆ**: å¯é›†æˆåˆ° CI/CD æµæ°´çº¿

### æœ€ä½³å®è·µ
1. **å¼€å‘é˜¶æ®µ**: ä½¿ç”¨ `--no-llm-judge` è¿›è¡Œå¿«é€Ÿæµ‹è¯•
2. **æµ‹è¯•é˜¶æ®µ**: å¯ç”¨ LLM Judge è¿›è¡Œæ·±åº¦åˆ†æ
3. **ç”Ÿäº§éƒ¨ç½²å‰**: è¿è¡Œå®Œæ•´çš„å®‰å…¨å®¡è®¡
4. **CI/CD**: é›†æˆåˆ°è‡ªåŠ¨åŒ–æµæ°´çº¿ï¼Œæ¯æ¬¡æäº¤éƒ½è¿è¡Œ
5. **å®šæœŸå®¡è®¡**: å®šæœŸå¯¹ç”Ÿäº§å·¥ä½œæµè¿›è¡Œå®‰å…¨æ‰«æ

### ç›¸å…³æ–‡æ¡£
- **README**: `tests/evoagent_bench/README.md`
- **è®¾è®¡æ–‡æ¡£**: `docs/plans/2026-02-04-evoagent-workflow-testing-design.md`
- **é£é™©å®šä¹‰**: `MASé£é™©å±‚çº§è¯´æ˜.md`
- **æ¶æ„åˆ†æ**: `docs/SRC_ARCHITECTURE_ANALYSIS.md`

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0
**æœ€åæ›´æ–°**: 2026-02-05
**ç»´æŠ¤è€…**: MASSafetyGuard Team